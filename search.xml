<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>math Quadratic residue</title>
      <link href="/math-quadratic-residue/"/>
      <url>/math-quadratic-residue/</url>
      
        <content type="html"><![CDATA[<h3 id="二次剩余"><a href="#二次剩余" class="headerlink" title="二次剩余"></a>二次剩余</h3><p>若同余式<br>$$<br>x^2 \equiv a \quad (mod \; m), \qquad (a, m) = 1<br>$$<br>有解，则 $a$ 叫做模 $m$ 的<strong>平方/二次剩余</strong>，否则称为<strong>平方/二次非剩余</strong></p><h3 id="模为奇素数的平方剩余"><a href="#模为奇素数的平方剩余" class="headerlink" title="模为奇素数的平方剩余"></a>模为奇素数的平方剩余</h3><h4 id="欧拉判别条件"><a href="#欧拉判别条件" class="headerlink" title="欧拉判别条件"></a>欧拉判别条件</h4><p>$a$ 是模 $p$ 的平方剩余的充要条件是<br>$$<br>a^{(p-1)/2} \equiv 1 \quad (mod \; p)<br>$$<br>$a$ 是模 $p$ 的平方非剩余的充要条件是<br>$$<br>a^{(p-1)/2} \equiv -1 \quad (mod \; p)<br>$$<br>并且当 $a$ 是模 $p$ 的平方非剩余时，恰有两解</p><p>例子：判断 $137$ 是否是 $227$ 的平方剩余</p><p>由 $137^{(227-1)/2} \equiv -1 \quad (mod \; 227)$，知 $137$ 是 $227$ 的平方非剩余</p><h4 id="定理二"><a href="#定理二" class="headerlink" title="定理二"></a>定理二</h4><p>设 $p$ 是奇素数，则模 $p$ 的简化剩余系中平方剩余与平方非剩余的个数各为 $(p-1)/2$，且 $(p-1)/2$ 个平方非剩余与序列：<br>$$<br>1^2, 2^2, \dots , (\cfrac{p-1}{2})^2<br>$$<br>中一个数同余，且仅与一个数同余</p><h3 style="color: red;">     勒让德符号</h3><p>$$<br>(\cfrac{a}{p}) = \begin{cases}<br>1, \quad &amp; 若 a 是模 p 的平方剩余 \\<br>-1, &amp; 若 a 是模 p 的平方非剩余 \\<br>0, &amp; 若 p | a<br>\end{cases}<br>$$</p><h4 id="高斯引理"><a href="#高斯引理" class="headerlink" title="高斯引理"></a>高斯引理</h4><p>$p$ 是奇素数，$a$ 是整数，$(a, p) = 1$，如果整数<br>$$<br>a \cdot 1, a \cdot 2, \dots, a \cdot \frac{p-1}{2}<br>$$<br>中模 $p$ 的最小正剩余中大于 $\frac{p}{2}$ 的个数是 $m$ ，则<br>$$<br>(\cfrac{a}{p}) = (-1)^m<br>$$</p><h4 id="性质"><a href="#性质" class="headerlink" title="性质"></a>性质</h4><ul><li><p>$(\cfrac{a}{p}) \equiv a^{(p-1) / 2} \quad (mod \; p)$</p></li><li><p>$(\cfrac{a}{p}) = (\cfrac{a+kp}{p})$</p></li><li><p>$(\cfrac{a}{p})(\cfrac{b}{p}) = (\cfrac{ab}{p})$</p></li><li><p>若$(a, p) = 1$，则 $(\cfrac{a^2}{p}) = 1$</p></li><li><p>$(\cfrac{2}{p}) = (-1)^{\frac{p^2-1}{8}}$</p></li><li><p>若 $(a, 2p) = 1$， 则 $(\cfrac{a}{p}) = (-1)^{T(a,p)}$</p></li></ul><p>$$<br>T(a, p) = \sum_{k=1}^{(p-1)/2} [\cfrac{ak}{p}]<br>$$</p><h3 style="color: red;">    二次互反律</h3><p>$p, q$ 是互素的<strong>奇素数</strong>，则<br>$$<br>(\cfrac{p}{q}) = (-1)^{\frac{p-1}{2} \cdot \frac{q-1}{2}} (\cfrac{q}{p})<br>$$<br><strong>注：</strong>二次互反律成立的条件必须是<strong>奇素数</strong></p><p>例子：判断同余式 $x^2 \equiv 137 \quad (mod \; 227)$ 是否有解<br>$$<br>\begin{align}<br>(\cfrac{137}{227}) = &amp; (-1)^{(\frac{137-1}{2}) \times (\frac{227-1}{2})} \times (\cfrac{90}{137}) \\<br>= &amp; (\cfrac{2}{137}) \times (\cfrac{5}{137}) \times (\cfrac{3^2}{137}) \\<br>= &amp; (-1)^{(137^2-1)/8} \times (-1)^{2 \times 68} \times (\cfrac{2}{5}) \\<br>= &amp; 1 \times (-1)^{(5^2-1)/8} \\<br>= &amp; -1<br>\end{align}<br>$$</p><h3 style="color: red;">     雅可比符号</h3><p>雅可比符号同勒让德符号的书写一样，且只要求 $m$ 是奇数，$a$ 可以为任意整数<br>$$<br>\frac{a}{m}<br>$$<br>但是要注意的是，雅可比符号只能用来判断是否是<strong>二次非剩余</strong>，而<strong>不能判断是否是二次剩余</strong></p><p><strong>雅可比符号</strong>具有和勒让德符号一样的性质，包括二次互反律</p><p><strong>注：</strong>二次互反律只在 $a,m$ 均是奇数的时候成立</p><p>例子：判断同余式<br>$$<br>x^2 \equiv 286 \quad (mod \; 563)<br>$$<br>是否有解<br>$$<br>\begin{align}<br>(\cfrac{286}{563}) = &amp; (\cfrac{2}{563}) \times (\cfrac{143}{563}) \\<br>= &amp; (-1)^{(563^2-1)/8} \times (-1)^{\frac{143-1}{2} \times \frac{563-1}{2}} \times (\cfrac{-9}{143}) \\<br>= &amp; (\cfrac{-1}{143}) \\<br>= &amp; -1<br>\end{align}<br>$$<br>故无解</p><h3 id="模-p-平方根"><a href="#模-p-平方根" class="headerlink" title="模 $p$ 平方根"></a>模 $p$ 平方根</h3><p>设 $p$ 是形如 $4k+3$ 型的素数，则同余式<br>$$<br>x^2 \equiv a \quad (mod \; p)<br>$$<br>的解为<br>$$<br>x \equiv \pm a^{\frac{p+1}{4}} \quad (mop \; p)<br>$$<br>更复杂的情况暂时略</p><h3 style="color: red;">    Rabin密码体制</h3><p>随机选择两个形如 $4k+3$ 的大素数 $p, q$，计算 $n = p \times q$，以 $n$ 作为公开密钥，$p, q$ 作为私有密钥，则密文 $c \equiv m^2 \quad (mod \; n)$，解密即为求方程组<br>$$<br>\begin{cases}<br>x^2 \equiv c \quad (mod \; q) \\<br>x^2 \equiv c \quad (mod \; p)<br>\end{cases}<br>$$<br>由中国剩余定理可知解共有 $4$ 个，于是需要在明文 $m$ 中添加某些信息来确保解密的结果唯一</p><p>例子：取 $p=7, q = 11$</p><ol><li>若明文 $m = 16$，求加密后的密文 $c$</li><li>若密文 $c = 23$，求对应的 $4$ 个明文</li></ol><p>一：<br>$$<br>c  = 16 ^ 2 \equiv  25 \quad (mod \; 77) \\<br>$$<br>二：<br>$$<br>\begin{cases}<br>x^2 \equiv 23 \equiv 2 \quad (mod \; 7) \\<br>x^2 \equiv 23 \equiv 1 \quad (mod \; 11)<br>\end{cases}<br>$$<br>故解为<br>$$<br>\begin{cases}<br>x \equiv \pm 2^{(7+1)/4} \quad (mod \; 7) \\<br>x \equiv \pm 1^{(11+1)/4} \quad (mod \; 11)<br>\end{cases}<br>$$<br>再有中国剩余定理可知四个解为<br>$$<br>x \equiv \pm 4 \times 22 + \pm 1 \times 56 \equiv 10、32、45、67<br>$$</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> math </category>
          
      </categories>
      
      
        <tags>
            
            <tag> math </tag>
            
            <tag> infomation security </tag>
            
            <tag> course </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>congruence polynomial</title>
      <link href="/math-congruence-polynomial/"/>
      <url>/math-congruence-polynomial/</url>
      
        <content type="html"><![CDATA[<h3 id="同余式"><a href="#同余式" class="headerlink" title="同余式"></a>同余式</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>$m \in Z^+$，$f(x)=a_nx^n+ \cdots + a_0$，且 $a_i \in Z$，则<br>$$<br>f(x) \equiv 0 \quad (mod \; m)<br>$$<br>称为模 $m$ 同余式，若 $a_n \neq 0 \quad (mod \; m)$，则 $n$ 叫做 $f(x)$ 的次数，记为 $deg f$，上述式子还可以称为模 $m$ 的 $n$ 次同余式，若 $x \equiv a \quad (mod \; m)$ 使得上述式子成立，则称其为同余式的解</p><h3 id="一次同余式"><a href="#一次同余式" class="headerlink" title="一次同余式"></a>一次同余式</h3><p>$m \in Z^+$，$a \in Z$ 且 $m \nmid a$，则一次同余式<br>$$<br>ax \equiv b \quad (mod \; m)<br>$$<br>有解的充要条件是 $(a, m) | b$，若有解，则其解为：<br>$$<br>x \equiv \cfrac{b}{(a, m)}((\cfrac{a}{(a, m)})^{-1} \quad (mod \; \cfrac{m}{(a, m)})) + t \cdot \cfrac{m}{(a, m)} \quad (mod \; m)<br>$$<br>例子：求解同余式<br>$$<br>33x \equiv 22 \quad (mod \; 77)<br>$$<br>$(33, 77) = 11 | 22 \implies$ 有解</p><p>$3x \equiv 2 \quad (mod \; 7)$ 的解为3</p><p>故全部解为 $3 + 7t, \quad t \in [0, 10]$</p><h3 style="color: red;">    中国剩余定理</h3><p>设 $m_i$ 是 $k$ 个两两互素的正整数，则 $\forall b_i$，同余式组<br>$$<br>\begin{cases}<br>x \equiv b_1 \quad (mod \; m_1) \\<br>\dots \\<br>x \equiv b_k \quad (mod \; m_k)<br>\end{cases}<br>$$<br>有唯一解，若零 $m = \Pi m_i$，$m = m_i \cdot M_i$，$M_i^{-1}M_i \equiv 1 \quad (mod \; m_i)$，则<br>$$<br>x \equiv \sum b_i \cdot M_i \cdot M_i^{-1} \quad (mod \; m)<br>$$</p><p>例子：求解同余式组<br>$$<br>\begin{cases}<br>x \equiv b_1 \quad (mod \; 5) \\<br>x \equiv b_2 \quad (mod \; 6) \\<br>x \equiv b_3 \quad (mod \; 7) \\<br>x \equiv b_4 \quad (mod \; 11)<br>\end{cases}<br>$$<br>$M_1=6 \times 7 \times 11 = 462$，类似求得 $M_2=385$，$M_3=330$，$M_4=210$</p><p>$3 \times M_1 \equiv 1 \quad (mod \;5) \implies M_1^{-1}=3$，类似球的 $M_2^{-1}=1$，$M_3^{-1}=1$，$M_4^{-1}=1$</p><p>带入可知解为<br>$$<br>x \equiv 1386b_1 + 385b_2 + 330b_3 + 210b_4 \quad (mod \; 2310)<br>$$</p><h3 style="color: red;"> 高次同余式的解数及解法</h3><h4 id="中国剩余定理-暴力计算"><a href="#中国剩余定理-暴力计算" class="headerlink" title="中国剩余定理+暴力计算"></a>中国剩余定理+暴力计算</h4><p>略</p><h4 id="高次同余式的提升"><a href="#高次同余式的提升" class="headerlink" title="高次同余式的提升"></a>高次同余式的提升</h4><p>当 $p$ 为素数时，求解多项式 $f(x) \equiv 0 \quad (mod \; p^{\alpha})$</p><p>设 $x \equiv x_1 \quad (mod \; p)$ 是同余式<br>$$<br>f(x) \equiv 0 \quad (mod \; p)<br>$$<br>的一个解，且<br>$$<br>(f’(x_1), p) = 1<br>$$<br>则 $f(x) \equiv 0 \quad (mod \; p^{\alpha})$ 有解<br>$$<br>x \equiv x_{\alpha} \quad (mod \; p^{\alpha})<br>$$<br>其中 $x_{\alpha}$ 满足递归关系式<br>$$<br>\begin{align}<br>&amp; x_i \equiv x_{i-1} + t_{i-1} \cdot p^{i-1} \quad (mod \; p^i) \\<br>&amp; t_{i-1} \equiv \cfrac{-f(x_{i-1})}{p^{i-1}} \cdot (f’(x_1)^{-1} \; (mod \; p)) \quad (mod \; p)<br>\end{align}<br>$$<br>例子：求解同余式 $f(x) \equiv x^4 + 7x + 4 \equiv 0 \quad (mod \; 27)$</p><p>易得 $f(x) \equiv 0 \quad (mod \; 3)$ 的解为 $x_1 \equiv 1$，又 $f’(x_1) = 11 \implies (11, 3) = 1$ 故有解，且 $f’(x_1)^{-1} \equiv 2 \quad (mod \; 3)$ 根据递推关系式可计算得到 $t_1 \equiv 2, x_2 \equiv 4, t_2 \equiv 2, x_3 \equiv 22 $ ，故解为22</p><h3 id="求解素数模的同余式"><a href="#求解素数模的同余式" class="headerlink" title="求解素数模的同余式"></a>求解素数模的同余式</h3><h4 id="多项式欧几里得除法"><a href="#多项式欧几里得除法" class="headerlink" title="多项式欧几里得除法"></a>多项式欧几里得除法</h4><p>$f(x)$ 为 $n$ 次整系数多项式，$g(x)$ 为 $m$ 次首一整系数多项式，则存在整系数多项式 $q(x)$ 和 $r(x)$，使得<br>$$<br>f(x) = q(x) \cdot g(x) + r(x), \qquad deg \; r(x) &lt; deg \; g(x)<br>$$<br>由费马小定理及上述结论可知 $f(x)$ 与一个次数不超过 $p-1$ 的模 $p$ 同余式等价<br>$$<br>f(x) = q(x) \cdot (x^p - x) + r(x)<br>$$</p><h4 id="素数模同余式的因式分解"><a href="#素数模同余式的因式分解" class="headerlink" title="素数模同余式的因式分解"></a>素数模同余式的因式分解</h4><p>素数模同余式满足因式分解定理</p><h4 id="素数模同余式的解数估计"><a href="#素数模同余式的解数估计" class="headerlink" title="素数模同余式的解数估计"></a>素数模同余式的解数估计</h4><p>$f(x)$ 的解数不超过其次数(因式分解立证)</p><h4 id="解的判断"><a href="#解的判断" class="headerlink" title="解的判断"></a>解的判断</h4><p>$p$ 是一个素数，$n \in Z^+$，$n \le p$，则<br>$$<br>f(x) = x^n + \cdots + a_1x + a_0 \equiv \quad (mod \; p)<br>$$<br>有 $n$ 个解的充要条件是 $x^p - x$ 被 $f(x)$ 除所得的余式的所有系数都是 $p$ 的倍数</p><p>例子：判断同余式<br>$$<br>2x^3 + 5x^2 + 6x + 1 \equiv 0 \quad (mod \; 7)<br>$$<br>是否有三个解</p><p>首先将多项式两边 $\times 4$ 变成首1多项式<br>$$<br>4 \times (2x^3 + 5x^2 + 6x + 1) \equiv x^3 - x^2 + 3x - 3<br>$$<br>又有<br>$$<br>x^7 - x \equiv x(x^3+x^2-2x-2) \cdot (x^3 - x^2 + 3x - 3) + 7x(x^2-1)<br>$$<br>故有三个解</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> math </category>
          
      </categories>
      
      
        <tags>
            
            <tag> math </tag>
            
            <tag> infomation security </tag>
            
            <tag> course </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>开发存储器层次结构</title>
      <link href="/cod-kai-fa-cun-chu-qi-ceng-ci-jie-gou/"/>
      <url>/cod-kai-fa-cun-chu-qi-ceng-ci-jie-gou/</url>
      
        <content type="html"><![CDATA[<h3 id="局部性原理："><a href="#局部性原理：" class="headerlink" title="局部性原理："></a>局部性原理：</h3><ul><li>时间局部性：如果某个数据项被访问，那么在不久的将来他可能再次被访问</li><li>空间局部性：如果某个数据项被访问，那么与地址相邻的数据项可能很快也将被访问</li><li>例子：循环结构体现了指令和数据的时间局部性；顺序执行和对数组或者记录中的元素进行顺序访问则体现了指令和数据的空间局部性</li></ul><h3 id="层次结构："><a href="#层次结构：" class="headerlink" title="层次结构："></a>层次结构：</h3><ul><li><p>存储器层次结构：一种由多存储器层次组成的结构，存储器的容量和访问时间随着离处理器距离的增加而增加</p></li><li><p>数据层次结构：靠近处理器那一层的数据是那些较远层次中的子集，<font color="lightblue">所有的数据</font>被存储在最缓慢的层</p></li><li><p>存储器的层次结构可以由多层构成，但是数据每次只能在相邻的两个层次之间进行复制，高层次的存储器靠近处理器，比低层存储器容量小但是访问速度更快。</p></li><li><p>两级层次结构中存储信息交换的最小单元称为块或行</p></li></ul><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><ul><li>块或行：两级层次结构中存储信息交换的最小单元</li><li>命中率：在高层存储器中找到目标数据的存储访问比例</li><li>缺失率：1-命中率</li><li>命中时间：访问某存储器层次结构所需要的时间，包括了判断当前访问是命中还是缺失所需的时间</li><li>缺失代价：将相应的块或行从低层存储器替换到高层存储器以及将该信息快传送给处理器的时间之和</li></ul><h3 id="存储器技术："><a href="#存储器技术：" class="headerlink" title="存储器技术："></a>存储器技术：</h3><ul><li>一些典型的存储器：<img src="/img/cod/14.png" alt="喵喵喵"></li><li>闪存：一种电可擦除的可编程只读存储器</li><li>磁盘存储器：<ul><li>磁道：位于磁盘表面的数万个同心圆环中的任意一个圆环称为一个磁道</li><li>扇区：构成磁盘上磁道的基本单位，是磁盘上数据读写的最小单位</li><li>每个扇区的容量通常是512-4096字节，信息在磁介质上保存的顺序为扇区号、一个间隙、包含该扇区的纠错码、一个间隙、下一个扇区的扇区号</li><li>为了访问数据，操作系统必须对磁盘进行三步操作：<ul><li>寻道：把读写磁头移动到磁盘上适当的磁道上面</li><li>扇区旋转：磁头到了正确的磁道后，必须等待要访问的扇区转动到读写头下面。等待的时间称为<strong>旋转延时</strong>，<strong>平均延时</strong>通常指磁盘转动一周时间的一半</li><li>？？？（读写数据？）</li></ul></li></ul></li></ul><h3 id="cache-基本原理："><a href="#cache-基本原理：" class="headerlink" title="cache 基本原理："></a>cache 基本原理：</h3><ul><li>直接映射：每个存储器中的数据项都放在cache中的确定位置</li></ul><p>较大的 cache 块能够更好的利用空间局部性以降低缺失率</p><h3 id="指令-cache-缺失时的处理步骤（指令存储器的-cache）："><a href="#指令-cache-缺失时的处理步骤（指令存储器的-cache）：" class="headerlink" title="指令 cache 缺失时的处理步骤（指令存储器的 cache）："></a>指令 cache 缺失时的处理步骤（指令存储器的 cache）：</h3><ol><li>把程序计数器 PC 和 原始值 PC-4 送到存储器中</li><li>通知主存执行一次读操作，并等待主存访问完成</li><li>写 cache 项，将从主存取回的数据写入 cache 中存放数据的部分，并设置 cache 中对应的（有效位，标记为和索引）</li><li>重启指令执行第一步，此时指令在 cache 中</li></ol><p><font color="lightblue">数据 cache 缺失</font>与指令 cache 缺失时的处理步骤基本相同，发生缺失时，处理器发生阻塞，直到从存储器中取回数据后才响应</p><p>写操作和读操作的不同之处在于：如果只将数据写入数据 cache（而不改变主存的内容），那么，再写入 cache 之后，主存与 cache 相应位置的值将<font color="red">不同</font>，此时 cache 和主存被认为<font color="red">不一致</font></p><h3 id="写操作："><a href="#写操作：" class="headerlink" title="写操作："></a>写操作：</h3><ul><li>写命中（处理器 sw 指令的地址在数据 cache 中）时保持 cache 和主存一致性的方法：<ul><li>写直达（写通过、写穿）：更新 cache 的同时更新下一存储器层次，保持二者的一致性<ul><li>写缓冲：一中解决写直达缓慢的解决方法。在一个数据等待被写入主存时，先将它放入写缓冲（保存等待写入主存数据的缓冲队列）中。如果写缓冲已经满了，则处理器必须阻塞直到写缓冲中有一个位置。（写缓冲写入内存主要存储器的写操作速度，数据写入写缓冲主要看处理器的写操作速度）当存储器完成写操作的速度慢于处理器产生写操作的速度，那么就必须产生上述阻塞，再多的缓冲器也没有用，当存储器的写操作速度快于处理器时，也有可能由于写冲突而发生阻塞</li></ul></li><li>写回：新值仅被写入 cache 中，直到修改过的块需要被替换（不论是读或者写，只要有内容替换）的时候才将该块写入下一存储器层次</li></ul></li><li>写缺失时的处理：<ul><li>写分配：将数据写入下一存储器层次，并将该块数据放回 cache</li><li>写不分配：将数据写入下一存储器层次，不放回 cache</li></ul></li><li>因为采用写回操作时，如果出现写缺失，更新操作可能造成 cache 中更新但是没有写入下一存储器层次的数据丢失（可以采用脏位），因此写回一般和写不分配搭配（并不绝对）</li></ul><p>在<font color="red">组相联</font>中，cache 的组成为</p><table><thead><tr><th>标记</th><th>索引</th><th>块偏移</th></tr></thead><tbody><tr><td>选择块</td><td>选择组</td><td>选择被请求的数据地址</td></tr></tbody></table><ul><li>全相联不需要索引位</li></ul><p>汉明码达到 DED 只需要加一位奇偶校验位校验所有的数据</p><h3 id="虚拟存储器"><a href="#虚拟存储器" class="headerlink" title="虚拟存储器"></a>虚拟存储器</h3><ul><li><p>一种将主存用作辅助存储器高速缓存的技术。主存可以看作硬盘的 cache（<font color="red">主存既有虚拟页号也有物理页号？？</font>）</p></li><li><p>虚拟存储器实现了程序地址空间（虚拟地址）到物理地址的转换，这种地址转换处理加强了各个程序地址空间之间的保护</p><ul><li>物理地址：主存储器的地址</li><li>保护：一组确保共享处理器、主存、I/O 设备的多个进程之间没有故意地、无意地读写其他进程地数据机制，这些保护机制可以将操作系统和用户的进程隔离开来</li></ul></li><li><p>虚拟存储器允许单用户使用超过主要存储器的容量</p></li><li><p>虚拟存储器和 cache 的工作原理是一样的，但是在虚拟存储器中，块被称之为页，访问缺失被称为缺页，在虚拟存储器中，处理器产生一个虚拟地址，再结合软硬件转换成一个物理地址</p><ul><li>缺页：访问的页不在主存储器中</li><li>虚拟地址：虚拟空间的地址，当需要访问主存时需要通过地址映射转换为物理地址</li><li>地址转换（地址映射）：在访问内存时将虚拟地址映射为物理地址</li></ul></li><li><p>虚拟存储器中通常采用写回机制，因为写直达的开销太大</p></li><li><p>页表：保存着虚拟地址和物理地址之间转换关系的表。包含有效位、虚页号和物理页号</p><ul><li>若有效位为 1，则表明该页在主存中，可以直接通过访问物理页号获取数据</li><li>若有效位为 0，表明该页不在主存中，即缺页，需要去磁盘访问</li><li>页表包含了每一个可能的虚拟页的映射</li></ul></li><li><p>因为虚拟存储器采用全相连映射，所以物理页号和虚拟页号其实没有什么关系</p></li></ul><p><strong>段式管理</strong>：一种可变长度的地址映射策略。其中每个地址由两部分组成：映射到物理地址的段号和段内偏移</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> computer science </category>
          
      </categories>
      
      
        <tags>
            
            <tag> computer science </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>处理器</title>
      <link href="/cod-chu-li-qi/"/>
      <url>/cod-chu-li-qi/</url>
      
        <content type="html"><![CDATA[<h3 id="逻辑单元："><a href="#逻辑单元：" class="headerlink" title="逻辑单元："></a>逻辑单元：</h3><ul><li>组合单元：处理数据值的单元，其输出只取决于当前的输入。例如：alu、门</li><li>状态单元：存储状态的单元。例如：指令存储器、数据存储器、寄存器。一个状态单元至少有两个输入（时钟信号和写入单元的值）和一个输出</li></ul><p>时钟方法：规定了信号可以读出和写入的时间，用来确定相对于时钟何时稳定和有效的方法</p><p>如果某状态单元在每个有效的时钟边沿都进行写入操作，则可以忽略写控制信号，否则需要写控制信号和时钟信号共同控制</p><p><font color="red">使用沿时钟边沿的写信号时，可以在一个周期同时进行读和写操作，因为在一个周期中随时可以读出数据，但是只有在时钟的边沿才能触发写操作</font> （不确定正确性）</p><h3 id="数据通路："><a href="#数据通路：" class="headerlink" title="数据通路："></a>数据通路：</h3><ul><li><p>数据通路部件：一个用来操作或保存处理器中数据的单元。在MIPS的实现中，数据通路部件包括：指令存储器、数据存储器、alu、寄存器堆、加法器（<font color="red">这个算alu吗？</font>）</p></li><li><p>指令存储器是<font color="lightblue">只读的</font>，可以视为<font color="lightblue">组合逻辑</font>：任意时刻的输出都反映了输入地址处的内容，从而不需要读控制信号（忽略了装载程序时写入指令）</p></li><li><p>程序计数器在每个时钟周期末都会被写入（多周期似乎并不是如此），从而不需要写控制信号</p></li><li><p>加法器可以看成只进行加法的<font color="lightblue">alu</font></p></li><li><p>寄存器堆：寄存器的集合，包含了计算机寄存器的状态。其中的寄存器都可以通过指定相应的寄存器号来进行读写。寄存器堆包含有4个输入（3个寄存器号（2个读1个写）+1个要写入的数据）</p></li><li><p>因为写操作是在时钟边沿触发的，而读操作并非是在时钟边沿触发的，因此同一个时钟周期可以进行读写操作，且读的数据是该时钟周期写入之前的数据</p></li><li><p>数据存储器有两个时钟信号，<font color="lightblue">读、写控制信号</font>，且任意一个时钟周期只能激活其中的一个信号。有读控制信号的原因是可能会读取一个无效的地址</p></li><li><p>在 beq 指令中，立即数字段<font color="lightblue">先拓展再左移</font></p></li><li><p>alu控制信号的产生使用了<font color="lightblue">多级译码</font>的方式。即，主控制单元生成 aluop 作为 alu 控制单元的输入，再由 alu 控制单元生成真正的 alu 控制信号。使用多级译码可以减少主控制单元的规模，使用多个小控制单元还可以提高控制单元的速度。</p></li></ul><h3 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h3><ul><li>单周期设计可以正确的工作，但现代设计中往往并不采用这种方式，因为效率太低。单周期设计中，时钟周期必须对所有指令等长，这样，时钟周期由执行时间最长的那条指令决定（lw指令），它使用了五个功能单元：指令存储器、寄存器堆、alu、数据存储器、寄存器堆</li></ul><h3 id="一个MIPS指令通常包含的步骤："><a href="#一个MIPS指令通常包含的步骤：" class="headerlink" title="一个MIPS指令通常包含的步骤："></a>一个MIPS指令通常包含的步骤：</h3><ol><li>从指令存储器中读取指令</li><li>指令译码的同时读取寄存器</li><li>执行操作或者计算地址</li><li>从数据存储器中读取操作数</li><li>写回寄存器</li></ol><p>流水线的时钟周期应该视为最慢的<font color="lightblue">功能单元</font>的时间</p><p>流水线所带来的性能提高是通过<font color="lightblue">增加指令的吞吐量</font>，而不是<font color="pink">减少单条指令的执行时间</font></p><h3 id="MIPS适合流水线的原因："><a href="#MIPS适合流水线的原因：" class="headerlink" title="MIPS适合流水线的原因："></a>MIPS适合流水线的原因：</h3><ul><li>所有的MIPS指令的长度都是相同的</li><li>MIPS指令只有很少的几种格式</li><li>MIPS中的存储器操作数仅出现在存取指令中</li><li>MIPS中，所有的操作数必须在存储器中对齐</li></ul><p><font color="red">设计MIPS体系结构指令集的另一个原则</font>：每条 MIPS 指令最多只写一个结果并且在流水线的最后一级执行（为了简化旁路的设计）</p><h3 id="流水线冒险："><a href="#流水线冒险：" class="headerlink" title="流水线冒险："></a>流水线冒险：</h3><ul><li><p>定义：在下一个时钟周期中，下一条指令不能执行</p></li><li><p>冒险的种类</p><ul><li>结构冒险：硬件不支持多条指令在同一时钟周期执行</li><li>数据冒险：因无法提供指令执行所需数据而导致不能在预定时钟周期执行的情况</li><li>控制冒险：取到的指令不是所需要的（往往发生在分支跳转中）</li></ul></li><li><p>分支预测：一种解决控制冒险的方法，预测某一个分支结果并<font color="red">立即</font>（不论分支指令是在ID、EX或是MEM执行，下一条指令是预测的指令）沿预测方向执行，而不是等真正的分支结果确定后才开始执行</p></li><li><p>延迟分支：另一种解决控制冒险的方法，将一条不受该分支影响的指令插入决策指令的后面，在一条指令延迟之后再开始执行分支，<font color="red">不论是否分支，该指令都必须执行完</font>，可以看成总是预测分支不发生，但不会清除该指令（只有分支延迟较短的时候，延迟分支才有效，所以没有处理器使用超过一个时钟周期的延迟分支。对于更长的分支，一般使用硬件分支预测器）</p></li></ul><p>除了存储系统以外，流水线的有效运作是决定处理器 CPI 乃至其性能的最重要的因素</p><p>延迟：流水线的级数或者顺序执行过程中两条指令间的级数，也可认为是某条指令从开始到完成所需要的时间</p><h3 id="流水线的数据通路："><a href="#流水线的数据通路：" class="headerlink" title="流水线的数据通路："></a>流水线的数据通路：</h3><ul><li><p>单周期中的指令流大致遵循从左至右的规律，但是有两个例外，这两个例外导致若将该数据通路直接运用到流水线中会导致数据冒险和结构冒险</p><ul><li>写回寄存器</li><li>选择PC的下一个值</li></ul></li><li><p>在流水线中为了从前面的流水级向后面的流水级传递信息，必须将信息放入<strong>流水线寄存器</strong>中，否则当下一条指令进入该流水级时这些信息将会丢失</p></li><li><p>数据通路中的每一个结构单元（指令存储器、寄存器读取端口、alu、数据存储器、寄存器写入端口等）都只能在一个流水级中使用，否则就会产生结构冒险</p></li><li><p>流水线的两种表示方法：</p><ul><li>多时钟周期的流水线图：<img src="/img/cod/10.png" alt="喵喵喵"></li><li>单时钟周期的流水线图（从多时钟周期中抽取<strong>一列</strong>）：<img src="/img/cod/11.png" alt="喵喵喵"></li></ul></li><li><p>将指令译码阶段产生的控制信号存入流水线寄存器时，不同的流水线寄存器所需要存取的讯号数量不同：</p><ul><li>ID/EX：需要存储所有的9个控制信号</li><li>EX/MEM：需要存储除了4个用于计算阶段（ALUSrc、ALUOp、<font color="lightblue">RegDst（因为已经将要写入的寄存器号存入了流水线寄存器，所以不需要存储该信号）</font>）的剩下的五个控制信号</li><li>MEM/WB：存储除了3个用于存储阶段（MemRead、MemWrite、Branch）的剩下的两个控制信号（RegWrite、MemtoReg）</li></ul></li><li><p>EX 冒险：<br>$$<br>if (EX/MEM.RegWrite \quad<br>and \quad \\ (EX/MEM.RegisterRd \ne 0) \quad<br>and \quad \\ (EX/MEM.RegisterRd=ID/EX.RegisterRs(ID/EX.RegisterRt)))<br>$$</p></li><li><p>MEM 冒险：</p></li></ul><p>$$<br>if (MEM/WB.RegWrite \quad<br>and \quad \\ (MEM/WB.RegisterRd \ne 0) \quad<br>and \quad \\ (MEM/WB.RegisterRd=ID/EX.RegisterRs(ID/EX.RegisterRt)))<br>$$</p><ul><li><p>当同时发生 EX 冒险和 MEM 冒险的时候，按 <font color="lightblue">EX 冒险</font>来算</p></li><li><p>装载指令发生的冒险必须通过阻塞流水线一个周期：</p><ul><li>装载指令冒险检测单元：<br>$$<br>if (ID/EX.MemRead \quad<br>and \quad \\(ID/EX.RegisterRt = IF/ID.RegisterRt) \quad<br>or \quad \\(ID/EX.RegisterRt=IF/ID.RegisterRs)) \\<br>stall \quad the \quad pipeline<br>$$</li></ul></li><li><p>当ID级的指令被阻塞时，其IF级的指令也必须被阻塞，否则已经取到的指令就可能丢失，因此<font color="lightblue">需要保持PC寄存器和IF/ID流水线寄存器不变</font></p></li><li><p>插入空指令的方法是将该指令的控制信号全部清零（这里事实上只需要将RegWrite、MemWrite清零，因为只有这两个的写入可能会改变原有的值），并且阻塞该指令之前的指令（参见上一条）</p></li></ul><h3 id="缩短分支的延迟："><a href="#缩短分支的延迟：" class="headerlink" title="缩短分支的延迟："></a>缩短分支的延迟：</h3><ul><li>将分支地址的计算和分支条件的判断提前到 ID 级（<font color="red">这里有可能会产生两种比较复杂的因素</font>）：<ul><li>需要引入新的旁路单元（分支指令的操作数可能来自 ALU/MEM 或 MEM/WB）</li><li>可能需要阻塞流水线（需要冒险检测单元）：<ul><li>遇到 R 型指令冒险时需要阻塞一个周期</li><li>遇到 load 指令冒险时需要阻塞两个周期</li></ul></li></ul></li><li>如果遇到数据冒险需要阻塞相应的时钟周期（alu指令1个时钟周期，lw指令两个时钟周期）</li></ul><h3 id="动态分支预测："><a href="#动态分支预测：" class="headerlink" title="动态分支预测："></a>动态分支预测：</h3><ul><li>动态分支预测：查找指令的地址观察上一次执行该指令时分支是否发生，如果上一次分支发生，就从上次分支发生的地方开始取新的信号</li><li>一种实现方法是采用分支预测缓存或者分支记录表：分支预测缓存是一小块按照分支地址低位索引的存储器区，其中包括一位或者多位数据用以说明最近是否发生过分支</li></ul><p>分支指令时间槽：紧跟延迟分支指令的时间片，在MIPS体系结构中，用不影响分支的一条指令填充到该时间片中</p><p>分支目标缓存：一种用于缓存分支目标地址或分支目标指令的结构，其一般形式为带标志位的 cache（硬件开销大于简单的分支预测缓存器）</p><p>相关预测器：综合考虑特定分支的局部行为和最近执行分支的全局行为的分支预测器</p><p>竞争预测器：具有多种预测机制的分支预测器，其带有一个选择器，对给定分支可选择其中一个作为预测结果</p><h3 id="控制："><a href="#控制：" class="headerlink" title="控制："></a>控制：</h3><ul><li>异常：控制流中<font color="lightblue">任何</font>意外的改变，无论其产生的原因是来自处理器的内部还是外部（一般指内部）</li><li>中断：来自<font color="lightblue">处理器外部</font>的异常</li><li>例子：<img src="/img/cod/12.png" alt="喵喵喵"></li></ul><h3 id="异常处理："><a href="#异常处理：" class="headerlink" title="异常处理："></a>异常处理：</h3><ul><li>异常发生时处理器必须进行的基本操作是：在<strong>异常程序计数器（EPC）</strong>中保存出错指令的地址，并把控制权转交给操作系统的特定地址</li><li>操作系统除了要知道是哪条指令引起异常之外，还必须知道引起异常的原因，主要有两种方法用于表示异常的原因：<ul><li>设置一个状态寄存器，其中有一个字段用于记录异常产生的原因（MIPS中的方法）</li><li>向量中断：控制权被转移到由异常原因决定的地址处，例如：<img src="/img/cod/13.png" alt="喵喵喵"></li></ul></li><li>用于异常处理的寄存器：<ul><li>EPC：32位寄存器，用于保存发生异常的指令地址（向量中断也需要这样一个寄存器），实际上保存的是发生异常后面一条指令的地址</li><li>Cause：记录异常原因的寄存器，在MIPS体系结构中它是32位的，其中某一个字段用于异常原因的编码</li></ul></li></ul><h3 id="流水线中的异常："><a href="#流水线中的异常：" class="headerlink" title="流水线中的异常："></a>流水线中的异常：</h3><ul><li>在流水线实现中，异常可被视作另一种形式的控制冒险</li><li>在算术溢出导致的异常中：<ul><li>溢出指令后一条指令的地址保存到 EPC 中</li><li>该周期<font color="red">后面</font>所有的flush信号置为有效（前面的指令正常执行）</li><li>该指令的控制信号置为无效</li><li>异常指令地址被强制放入PC</li></ul></li><li>在流水线中有5条活动的指令，确定哪条指令引发异常以及处理发生多个异常的方法：<ul><li>对异常划分优先级</li><li>硬件对异常进行排序，从而使得最先发生异常的指令被中断</li></ul></li><li>EPC捕捉中断指令（后一条）的地址，MIPS的Cause寄存器在一个时钟周期内记录下所有可能的异常</li><li>如果Cause寄存器中保存有多个异常，当优先级最高的异常处理之后，会继续导致硬件中断，从而处理后面的异常</li><li>硬件与操作系统必须协同工作：<ul><li>硬件一般暂停指令流中导致异常的指令，同时执行完该指令前的所有指令，清除指令后的所有指令，并且预设一个寄存器描述异常发生的原因，保存异常发生的指令（下一条）的地址，然后跳转到预先确定的地址开始执行</li><li>操作系统查看异常发生的原因并采取相应的操作：<ul><li>对于一个未定义的指令异常、硬件错误异常或算术溢出异常，操作系统通常终止执行的程序并返回原因描述</li><li>对于I/O设备请求或操作系统服务调用，操作系统保存程序的当前状态，执行期望的任务，然后重新载入程序继续运行。在I/O设备请求的情况下，我们可能需要在继续执行发出I/O设备请求的任务前先运行另一个任务，因为该任务一般在I/O完成之后才能继续执行（一个最重要且频繁出现的异常是页缺失与TLB异常）</li></ul></li></ul></li></ul><h3 id="异常的类型："><a href="#异常的类型：" class="headerlink" title="异常的类型："></a>异常的类型：</h3><ul><li>非精确中断：也称为非精确异常，流水线计算机中的中断或异常不与导致中断或异常的指令准确的关联，而让操作系统来决定</li><li>精确中断：也成为精确异常，流水线计算机中的中断或异常与导致中断或异常的指令准确的关联</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> computer science </category>
          
      </categories>
      
      
        <tags>
            
            <tag> computer science </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>计算机的算术运算</title>
      <link href="/cod-ji-suan-ji-de-suan-zhu-yun-suan/"/>
      <url>/cod-ji-suan-ji-de-suan-zhu-yun-suan/</url>
      
        <content type="html"><![CDATA[<h3 id="溢出发生的条件："><a href="#溢出发生的条件：" class="headerlink" title="溢出发生的条件："></a>溢出发生的条件：</h3><ul><li>加法：<ul><li>同正得负</li><li>同负得正</li></ul></li><li>减法：<ul><li>正负得负</li><li>负正得正</li></ul></li></ul><p>对于 MiPS 指令而言：</p><ul><li>有符号数的加减法（add、sub、addi）在溢出时产生异常</li><li>无符号数的加减法（addu、subu、addiu）在溢出时不产生异常</li></ul><p><strong>addiu</strong> 在做无符号数的加法时，立即数<font color="lightblue"><strong>符号扩展</strong></font>至32位</p><p>MIPS 使用异常程序计数器 $EPC$ 来保存导致异常的指令地址，指令 $mcf0$ 用来将 $EPC$ 存入一个通用寄存器</p><p><strong>饱和</strong>操作是指结果发生溢出时，结果被设置为最大的正数或者最小的负数，一般用于多媒体操作</p><p>检测 MIPS 溢出举例：</p><ol><li><p>对于有符号加法检测的步骤为：</p><ol><li>首先判断加数和被加数的符号是否相异，如果相异则不会溢出，否则进行下一步检验</li><li>判断相加之后的结果于原来加数的符号是否相同</li></ol><ul><li>代码如下：<img src="/img/cod/9.png" alt="喵喵喵"></li></ul></li><li><p>对于无符号加法的检测步骤为：</p><ol><li>判断两数之和是否超过 $2^{31}-1$ ，方法为将其中一个加数取反看是否小于另一个加数</li><li>代码如下：<img src="/img/cod/8.png" alt="喵喵喵"></li></ol></li></ol><h3 id="MIPS-提供了寄存器-Hi-和-Lo-来容纳乘法过程中-64-位的乘积，例如："><a href="#MIPS-提供了寄存器-Hi-和-Lo-来容纳乘法过程中-64-位的乘积，例如：" class="headerlink" title="MIPS 提供了寄存器 $Hi$ 和 $Lo$ 来容纳乘法过程中 64 位的乘积，例如："></a>MIPS 提供了寄存器 $Hi$ 和 $Lo$ 来容纳乘法过程中 64 位的乘积，例如：</h3><ul><li>$mult/multu \quad rs,\; rt$ 将寄存器 $rs$ 和 $rt$ 的数据相乘，乘积的低32位存入$Lo$ ,高32位存入 $Hi$ </li><li>指令 $mul \quad rd,\; rs,\; rt$ 将 $rs$ 和 $rt$ 乘积的低32位存入寄存器 $rd$ 中</li><li>指令 $mfhi/mflo \quad rd$ 将 $Hi/Lo$ 的值送入寄存器 $rd$ </li></ul><p>MIPS 乘法指令都忽略溢出，需要有如软件来检测是否可能因为积过大而32位不够表示，对于 multu 指令，可以检测 Hi 的值是否为0，对于mult 指令，可以检测 Hi 的值是否为 Lo 的符号为</p><p>在有符号的除法中，必须满足等式 $被除数=商 \times 除数 + 余数$ 以及<strong> $-(x \div y)=(-x)\div y$</strong>，因此余数的正负号的设置必须格外小心，例如：</p><ul><li>$-7 \div 2=-3…-1$ 而不是 <font color="red">$-7 \div 2 = -4…1$</font>  （不满足后面一条性质）</li></ul><h3 id="提供了-Hi-和-Lo-来存储余数和商："><a href="#提供了-Hi-和-Lo-来存储余数和商：" class="headerlink" title="提供了 $Hi$ 和 $Lo$ 来存储余数和商："></a>提供了 $Hi$ 和 $Lo$ 来存储余数和商：</h3><ul><li>$div \quad rs,\; rt$ 将 $rs \div rt$ 的商存入寄存器 $Lo$，余数存入寄存器 $Hi$ </li><li>$divu$ 无符号的除法</li></ul><p>MIPS 除法指令同样忽略溢出，需要软件来检测商是否溢出</p><p><font color="red">P130精解不理解</font></p><p>检测溢出可以用最高为的进位和次高为的进位相异或，$1 \Rightarrow Overflow \quad else \; no \; overflow$ </p><p><strong>规格化数</strong>：没有前导零且小数点左边只有一位整数（如 $1.0*10^{-9}$）</p><p>MIPS 中浮点数的表示：1位符号位+8位指数位+23位尾数位（指数部分表示数的范围，尾数部分表示数的精度），MIPS 中浮点数的值可用 $(-1)^S \times (1+F) \times 2^E$ 其中 $F$ 为尾数，$E$ 为指数</p><h3 id="浮点数的溢出："><a href="#浮点数的溢出：" class="headerlink" title="浮点数的溢出："></a>浮点数的溢出：</h3><ul><li>上溢：正的指数太大而导致指数域放不下的情况</li><li>下溢：负的指数太小而导致指数域放不下的情况</li></ul><h3 id="浮点数的精度："><a href="#浮点数的精度：" class="headerlink" title="浮点数的精度："></a>浮点数的精度：</h3><ul><li>单精度：浮点数由一个32位的字表示（1+8+23），范围约为 $2.0 \times 10^{\pm38}$ </li><li>双精度：浮点数由两个32位的字表示（1+11+52），范围约为 $2.0 \times 10^{\pm308}$</li></ul><p>为了提高精度，$IEEE \quad 754$ 通常省略了前导一，即将浮点数的表示为：$(-1)^S \times (1+F) \times 2^E$ ，$F \in [0,1)$ </p><p>如果从左到右标记尾数依次为 $s1, s2, s3, … ,s_t$ ，且指数的值为 $E$ ，则浮点数的值为：$(-1)^S \times [1+s_1 \times 2^{-1}+s_2 \times 2^{-2}+…] \times 2^E$ </p><img src="/img/cod/7.png" alt="喵喵喵"><h3 id="带偏阶的计数法："><a href="#带偏阶的计数法：" class="headerlink" title="带偏阶的计数法："></a>带偏阶的计数法：</h3><ul><li>希望计数法能将最小的负数表示为 $000…00_2$ ，最大的正数表示为 $1111…11_2$ ，我们通常在原数的基础上加上一个偏阶</li><li>$IEEE \quad 754$ 规定单精度的偏阶为 127，例如指数为-1时，会表示成126，即 $01111110_2$ ，指数为+1时，会表示成 128，即 $10000000_2$ ；双精度额偏阶规定为 1023，给指数带偏阶之后，浮点数的表示为： $(-1)^S \times (1+F) \times 2^{E-Bias}$ </li></ul><h3 id="求-0-75-10-的单精度和双精度表示："><a href="#求-0-75-10-的单精度和双精度表示：" class="headerlink" title="求 $-0.75_{10}$ 的单精度和双精度表示："></a>求 $-0.75_{10}$ 的单精度和双精度表示：</h3><ul><li>单精度：{1, 01111110, 100…0}</li><li>双精度：{1, 011111111110, 100…0}</li></ul><h3 id="浮点数加法的步骤："><a href="#浮点数加法的步骤：" class="headerlink" title="浮点数加法的步骤："></a>浮点数加法的步骤：</h3><ol><li>将指数较小的数向指数较大的数对齐</li><li>将有效数相加</li><li>规格化（不一定要做）</li><li>四舍五入（不一定要做，做了之后由于进位可能会返回步骤3）</li></ol><ul><li>例子1（假定有效位数为4）： $9.999 \times 10^{1}+1.610 \times 10^{-1}$<ol><li>$1.610 \times 10^{-1} \rightarrow 0.016 \times 10^1$ </li><li>$9.999 \times 10^1+0.016 \times 10^1=10.0015\times10^1$ </li><li>$10.0015 \times 10^1=1.0015 \times10^2$</li><li>$1.0015 \times 10^2 \rightarrow 1.002 \times 10^2$  </li></ol></li><li>例子2（假定有效位数为4）：$0.5_{10}+(-0.4375_{10})$ <ol><li>两者的科学表示分别为 $1.000 \times 2^{-1}、-1.110\times2^{-2}$ </li><li>$-1.110 \times 2^{-2} \rightarrow -0.111 \times2^{-1}$ </li><li>$1.000 \times 2^{-1} + -0.111 \times 2^{-1}=0.001\times2^{-1}$</li><li>$0.001\times2^{-1} \rightarrow 1.000 \times 2^{-4}$</li></ol></li><li>浮点数基本结构示意图：<img src="/img/cod/6.png" alt="喵喵喵"></li></ul><h3 id="浮点数乘法的步骤："><a href="#浮点数乘法的步骤：" class="headerlink" title="浮点数乘法的步骤："></a>浮点数乘法的步骤：</h3><ol><li>将源操作数的指数相加作为积的指数（注意要减去一个偏阶）</li><li>计算有效数的乘法</li><li>规格化（检查上溢或者下溢）</li><li>舍入</li><li>积的符号相同为正，相异为负</li></ol><ul><li>例子1（假定有效位为4）：计算 $0.5_{10} \times (-0.4375)_{10}$ <ol><li>二进制表示分别为：$1.000\times2^{-1}$ 和 $-1.110 \times 2^{-2}$ </li><li>计算积的偏阶为：$-1+(-2)=-3$ （此时是没有带偏阶的，所以不需要减去偏阶）</li><li>将有效数相乘：$1.000 \times 1.110=1.110$，因此此时得到的结果为 $1.110 \times 2^{-3}$ </li><li>符合规格化且没有发生溢出</li><li>舍入后结果不变</li><li>符号为 $-$ </li></ol></li></ul><h3 id="MIPS-中的浮点数指令："><a href="#MIPS-中的浮点数指令：" class="headerlink" title="MIPS 中的浮点数指令："></a>MIPS 中的浮点数指令：</h3><ul><li>MIPS 常见的浮点数指令为：<img src="/img/cod/5.png" alt="喵喵喵"></li><li>MIPS 中有32个32位浮点寄存器$(\$f_0,\$f_1,…,\$f_{31})$ ，单精度浮点数直接用某一个寄存器来表示，双精度浮点数由一组单精度寄存器（偶数+奇数）来表示，例如 $\$f_2,\$f_3$ 形成一个双精度寄存器，称为 $\$f_2$ </li><li>常见的浮点数指令如图：<img src="/img/cod/4.png" alt="喵喵喵"></li></ul><img src="/img/cod/3.png" alt="喵喵喵"><h3 id="浮点算数的精确性："><a href="#浮点算数的精确性：" class="headerlink" title="浮点算数的精确性："></a>浮点算数的精确性：</h3><ul><li>保护位：右边多保留的第一位</li><li>舍入位：右边多保留的第二位</li><li>粘贴位：当舍入位右边有非零的数即置1，主要用于当保护位和舍入位恰好是10的情况</li></ul><p><strong>混合乘加</strong>指令执行一次乘法和一次加法，但只在加法后执行一次舍入，能够提高浮点性能</p><h3 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h3><ul><li>为了从一次浮点操作中最大限度的获得精度，标准允许一些数（指数最小时）以非规格化的形式出现，例如：<ul><li>最小的正的单精度规格化数为：$1.00…0 \times 2^{-126}$ </li><li>最小的正的单精度非规格化数为：$0.000…1\times2^{-126}$ </li></ul></li><li>左移指令可以代替2的幂次方数相乘，右移指令<font color="red">不能</font>代替2的幂次方数相除（对于无符号整数是对的，但是对于有符号整数不一定正确（负数可能变成正数））</li><li>浮点数加法<font color="red">没有</font>结合律（例如$c=-1.5 \times 10^{38},a=1.5\times10^{38},b=1.0$，则$c+(a+b)=0$ 而 $(c+a)+b=1$） </li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> computer science </category>
          
      </categories>
      
      
        <tags>
            
            <tag> computer science </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>计算机的语言</title>
      <link href="/cod-ji-suan-ji-de-yu-yan/"/>
      <url>/cod-ji-suan-ji-de-yu-yan/</url>
      
        <content type="html"><![CDATA[<h3 id="常用的寄存器（32个）："><a href="#常用的寄存器（32个）：" class="headerlink" title="常用的寄存器（32个）："></a>常用的寄存器（32个）：</h3><ul><li>$\$0(\$zero)$：零寄存器，值恒为 $0$ </li><li>$\$1(\$at)$：寄存器 $at$ ，保留给汇编器使用</li><li>$\$2、\$3(\$v_0、\$v_1)$：函数返回值寄存器，调用时不保存</li><li>$\$4-\$7(\$a_0-\$a_3)$：函数参数寄存器，调用时不保存</li><li>$\$8-\$15、\$24-\$25(\$t_0-\$t_9)$：临时寄存器，调用时不保存</li><li>$\$16-\$23(\$s_0-\$s_7)$：保留寄存器，调用过程中必须被保存，保用完毕需要恢复之前值</li><li>$\$26-\$27(\$k_0-\$k_1)$：保留给异常处理函数使用</li><li>$\$28(\$gp)$：全局指针寄存器，调用时需要保存</li><li>$\$29(\$sp)$：栈指针寄存器，调用时需要保存</li><li>$\$30(\$fp)$：帧指针寄存器，调用时需要保存</li><li>$\$31(\$ra)$：返回地址寄存器，调用时需要保存</li></ul><img src="/img/cod/1.png" alt="喵喵喵"><p>MIPS 进行<strong>算数运算</strong>指令的操作数必须来自<strong><em>寄存器</em></strong></p><h5 id="硬件设计的基本原则："><a href="#硬件设计的基本原则：" class="headerlink" title="硬件设计的基本原则："></a>硬件设计的基本原则：</h5><ul><li>简单源于规整</li><li>越小越快</li><li>优秀的设计需要适宜的折衷方案</li></ul><p><strong>最高有效位</strong>指MIPS字中最左边的一位，<strong>最低有效位</strong>指最右边的一位，因为 MIPS 是 <font color="red">大端编址</font>，即地址低位对应数据高位</p><p>对于任意一个二进制数 $x$ 有，$\overline{x}+x+1=0$ ，即 $-x=\overline{x}+1$ ，若 $x$ 是正数， $-x$ 的补码为 $\overline{x}+1$ </p><h5 id="指令格式"><a href="#指令格式" class="headerlink" title="指令格式"></a>指令格式</h5><ul><li><p>$R$ 型指令：</p><ul><li><table><thead><tr><th align="center">op</th><th align="center">rs</th><th align="center">rt</th><th align="center">rd</th><th align="center">shamt</th><th align="center">funct</th></tr></thead><tbody><tr><td align="center">6</td><td align="center">5</td><td align="center">5</td><td align="center">5</td><td align="center">5</td><td align="center">6</td></tr></tbody></table></li><li><p>$R$ 型指令由 $op$ 和 $funct$ 字段决定指令的功能</p></li><li><p>$rs,rt$ 指源操作数寄存器</p></li><li><p>$rd$ 目的操作数寄存器</p></li><li><p>$shamt$ 位移量</p></li></ul></li><li><p>$I$ 型指令：</p><ul><li><table><thead><tr><th align="center">op</th><th align="center">rs</th><th align="center">rt</th><th align="center">imme</th></tr></thead><tbody><tr><td align="center">6</td><td align="center">5</td><td align="center">5</td><td align="center">16</td></tr></tbody></table></li><li><p>$rs$ 基址寄存器</p></li><li><p>$rt$ 目的寄存器</p></li><li><p>$imme$ 地址偏移量</p></li><li><p>$op$ 指令的功能</p></li></ul></li><li><p>$J$ 型指令：</p><ul><li><table><thead><tr><th align="center">op</th><th align="center">address</th></tr></thead><tbody><tr><td align="center">6</td><td align="center">26</td></tr></tbody></table></li><li><p>$op$ 指令的功能</p></li><li><p>$address$ 跳转的地址</p></li></ul></li></ul><h5 id="计算机基于两个重要的准则构建："><a href="#计算机基于两个重要的准则构建：" class="headerlink" title="计算机基于两个重要的准则构建："></a>计算机基于两个重要的准则构建：</h5><ul><li>指令用数的形式表示</li><li>和数据一样，程序存储在存储器中，并且可以读写</li></ul><p><strong>and</strong> 操作和先左移再进行右移都可以将字中的一部分分离出来</p><h5 id="基本块："><a href="#基本块：" class="headerlink" title="基本块："></a>基本块：</h5><ul><li>基本块是没有分支(可能出现在末尾者除外)，并且没有分支目标/分支标签(可能出现在开始者除外)的指令序列</li><li>编译最初阶段的任务之一就是将程序分解为若干基本块</li></ul><h5 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h5><ul><li>$C$ 语言中有很多的决策和循环语句，而 $MIPS$ 中却很少，这样的不均衡是因为：<ul><li>更多的决策语句使得代码更<font color="red">容易</font>被阅读和理解（相比于 mips 而言）</li><li>更少的决策语句简化了负责执行的底层工作</li><li>更多的决策语句意味着更少的代码量，这节约了编程的时间</li><li>更多的决策语句意味着更少的代码量，这意味着执行更少的操作</li></ul></li><li>注意 $C$ 语言中的 $\&amp;$ 和 $|$ 表示按位的逻辑操作，$\&amp;\&amp;$ 和 $||$ 表示条件分支</li></ul><p><strong>过程</strong>：根据提供的参数执行一定任务的存储的子程序</p><h5 id="过程运行中，程序必须遵守的步骤："><a href="#过程运行中，程序必须遵守的步骤：" class="headerlink" title="过程运行中，程序必须遵守的步骤："></a>过程运行中，程序必须遵守的步骤：</h5><ul><li>将参数放在过程可以访问的位置</li><li>将控制转交给过程</li><li>获得过程所需要的存储资源</li><li>执行需要的任务</li><li>将结果的值放在调用程序可以访问的位置</li><li>将控制返回初始点，因为一个过程可能由一个程序中的多个点调用</li></ul><h5 id="过程运行所需要的实体："><a href="#过程运行所需要的实体：" class="headerlink" title="过程运行所需要的实体："></a>过程运行所需要的实体：</h5><ul><li>调用者：调用一个过程并为过程提供必要参数值的程序</li><li>被调用者：根据调用者提供的参数执行一系列存储的指令，然后将控制权返回调用者的过程</li><li>程序计数器$(PC)$ ：包含在程序中正在被执行指令地址的寄存器</li></ul><p>在一个过程中，如果需要用到更多的寄存器 (多于4个参数寄存器和2个返回值寄存器)，则可能需要使用<font color="red">栈</font>来保护调用过程中的寄存器，例如 $\$t_0-\$t_9$ 属于临时寄存器，可以不必被调用者保存，$\$s_0-\$s_7$ 为保留寄存器，需要被调用者保存，<font color="red">由于可能存在嵌套过程，$ra$ 和参数寄存器也可能需要压栈</font></p><p>全局指针$gp$ ：指向静态数据区的保留寄存器</p><img src="/img/cod/2.png" alt="喵喵喵"><h3 id="加载-32-位常量（假定高十六位为-a，低十六位为-b）到寄存器-s-0-的操作："><a href="#加载-32-位常量（假定高十六位为-a，低十六位为-b）到寄存器-s-0-的操作：" class="headerlink" title="加载 32 位常量（假定高十六位为 a，低十六位为 b）到寄存器 $\$s_0$ 的操作："></a>加载 32 位常量（假定高十六位为 a，低十六位为 b）到寄存器 $\$s_0$ 的操作：</h3><ul><li><p>$lui \quad \$s_0, \; a$</p></li><li><p>$ori \quad \$s_0,\; b $</p></li></ul><p>保留寄存器 $\$at$ 通常用来创建长整数值</p><p>mips 中的条件分支寻址的形式为 <font color="purple">PC 相对寻址</font>，且是相对于 $PC+4$ 而不是当前指令 $PC$ ，并且寻址时的地址是<font color="pink">字地址</font> 而不是字节地址</p><p>$J$ 型指令的目标地址 $PC_{target}= \lbrace PC[31:28], addr &lt;&lt; 4\rbrace$ </p><h3 id="远距离的分支转移替换："><a href="#远距离的分支转移替换：" class="headerlink" title="远距离的分支转移替换："></a>远距离的分支转移替换：</h3><ul><li>$beq \quad \$s_0,\; \$s_1,\; L1$ 可以转换为下述指令：<ul><li>$bne \quad \$s_0,\; \$s1, \; L2$</li><li>$j \quad L1$ </li><li>$L2:\quad …$   </li></ul></li></ul><h3 id="MIPS-寻址模式"><a href="#MIPS-寻址模式" class="headerlink" title="MIPS 寻址模式"></a>MIPS 寻址模式</h3><ul><li>立即数寻址：操作数是位于指令自身的常数，如 (addi, subi等)</li><li>寄存器寻址：操作数是寄存器，如 (add, sub等)</li><li>基址寻址：操作数在内存中，其地址是指令中基址寄存器和常数的和，如 (lw, sw等)</li><li>PC 相对寻址：地址是PC和指令中常数 (左移两位)的和，如 (beq, bne等)</li><li>伪直接寻址：地址是PC高4位和26位立即数字段 (左移两位)组成</li></ul><p>数据竞争：假如来自不同线程的两个访存请求访问同一个地址，他们连续出现，并且至少其中一个是<font color="lightblue"><strong>写</strong></font>操作，那么这两个存储访问形成数据竞争</p><h3 id="翻译和执行程序的步骤："><a href="#翻译和执行程序的步骤：" class="headerlink" title="翻译和执行程序的步骤："></a>翻译和执行程序的步骤：</h3><ol><li>编译：将高级语言转化为汇编语言</li><li>汇编：将汇编语言转化为机器语言</li><li>链接：将多个模块和库程序组合在一起解析所有的引用</li><li>加载：将可执行程序加载到内存的适当位置</li></ol><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>计算机概要与技术</title>
      <link href="/cod-ji-suan-ji-gai-yao-yu-ji-zhu/"/>
      <url>/cod-ji-suan-ji-gai-yao-yu-ji-zhu/</url>
      
        <content type="html"><![CDATA[<h3 id="计算机的应用的分类及其特性："><a href="#计算机的应用的分类及其特性：" class="headerlink" title="计算机的应用的分类及其特性："></a>计算机的应用的分类及其特性：</h3><ul><li>个人计算机：用于个人使用的计算机，价格低廉，通常包含图形显示器、键盘和鼠标等</li><li>服务器：用于为多用户运行大型程序的计算机，通常由多个用户并行使用，并且一般通过网络访问</li><li>嵌入式计算机：嵌入到其他设备中的计算机，一般运行预定义的一个或者一组应用程序</li></ul><p>现代计算机的特征是<strong>处理器的并行性</strong>和<strong>内存的层次性</strong> </p><h3 id="程序的性能取决于："><a href="#程序的性能取决于：" class="headerlink" title="程序的性能取决于："></a>程序的性能取决于：</h3><ul><li>程序所用算法的有效性</li><li>用来建立程序并将其翻译成机器指令的软件系统</li><li>计算机执行机器指令的有效性</li></ul><h3 id="计算机结构中的-8-个伟大思想："><a href="#计算机结构中的-8-个伟大思想：" class="headerlink" title="计算机结构中的 8 个伟大思想："></a>计算机结构中的 8 个伟大思想：</h3><ul><li>面向摩尔定律的设计</li><li>使用抽象简化设计</li><li>加速大概率事件</li><li>通过并行提高性能</li><li>通过流水线提高性能</li><li>通过预测提高性能</li><li>存储器层次</li><li>通过冗余提高可靠性</li></ul><h3 id="软件的层次结构："><a href="#软件的层次结构：" class="headerlink" title="软件的层次结构："></a>软件的层次结构：</h3><ul><li>应用软件 $\rightarrow$ 系统软件 $\rightarrow$ 硬件</li><li>系统软件：提供常用服务的软件，包括操作系统、编译程序、加载程序和汇编程序等：<ul><li>操作系统：是用户和硬件之间的接口，为用户提供各种服务和监控功能，其最为重要的功能为：<ul><li>处理基本的输入和输出操作</li><li>分配外存和内存</li><li>为多个应用程序提供共享计算机资源的服务</li></ul></li><li>编译程序：把高级语言编写的程序翻译成硬件能执行的指令（机器语言）</li></ul></li></ul><h3 id="组成计算机的部件："><a href="#组成计算机的部件：" class="headerlink" title="组成计算机的部件："></a>组成计算机的部件：</h3><ul><li>输入</li><li>输出</li><li>存储器</li><li>处理器：<ul><li>数据通路（运算器）</li><li>控制器</li></ul></li></ul><h3 id="指令集体系结构-ISA"><a href="#指令集体系结构-ISA" class="headerlink" title="指令集体系结构 (ISA):"></a>指令集体系结构 (ISA):</h3><ul><li>是最重要的抽象之一，是硬件和底层软件之间的接口</li><li>计算机的体系结构包括程序员正确编写二进制机器语言所需的全部信息（如指令、I/O设备等）</li><li>提供给应用程序员的基本指令</li><li>令集和操作系统接口合成为<strong>应用二进制接口(ABI)</strong> </li></ul><h3 id="存储设备："><a href="#存储设备：" class="headerlink" title="存储设备："></a>存储设备：</h3><p>主存储器、二级存储器、磁盘、闪存</p><h3 id="联网的计算机的优点："><a href="#联网的计算机的优点：" class="headerlink" title="联网的计算机的优点："></a>联网的计算机的优点：</h3><p>通信、资源共享、远距离访问</p><h3 id="处理器制造中的一些概念："><a href="#处理器制造中的一些概念：" class="headerlink" title="处理器制造中的一些概念："></a>处理器制造中的一些概念：</h3><ul><li>定义：每块芯片的价格 $p_c$ ，每片晶圆的价格 $p_w$ ，每片晶圆的芯片数量 $m$ ，晶圆面积 $S$，成品率 $y$ ，合格芯片数量 $i$ ，总芯片数量 $I$ ，单位面积的瑕疵数量 $m_f$ ，芯片面积 $s$</li></ul><ol><li>$y=\frac{i}{I}$ ，$y=\frac{1}{(1+m_f·s/2)^2}$ （后一个公式是基于集成电路工厂的成品率经验） </li><li>$m \approx \frac{S}{s}$ （此处没有减去晶圆边上不满足芯片举行的面积）</li><li>$p_c=\frac{p_w}{m·y}$ </li></ol><p>性能定义为<strong>执行时间</strong>的倒数</p><h3 id="经典CPU性能公式："><a href="#经典CPU性能公式：" class="headerlink" title="经典CPU性能公式："></a><font color="red">经典CPU性能公式：</font></h3><ul><li>定义：$CPU$ 时间为 $t_{cpu}$ ，指令的数量为 $I$ ，每条指令执行的平均时间为 $CPI$ ，时钟周期的频率为 $f$ ，时钟周期的时间为 $t$</li><li>$t_{cpu}=I \times CPI/f=I \times CPI \times t$ </li></ul><p>唯一能够被完全可靠测量的计算机性能指标是<strong>时间</strong>，执行指令数量最少的代码其执行速度未必是最快的</p><h3 id="能耗的相关公式："><a href="#能耗的相关公式：" class="headerlink" title="能耗的相关公式："></a>能耗的相关公式：</h3><ul><li>能耗 $ \propto $ $\frac{1}{2} \times$ 负载电容 $\times$ 电压$^2$ </li><li>功耗 $ \propto $ $\frac{1}{2} \times$ 负载电容 $\times$ 电压$^2$ $\times$ 开关频率</li></ul><h3 id="谬误："><a href="#谬误：" class="headerlink" title="谬误："></a>谬误：</h3><ul><li>改进计算机的<strong><em>某个</em></strong>方面时期望总性能的提高与改进大小成正比：即，加速大概率事件不等于同等倍数的加速于整个程序</li><li>利用率低的计算机功耗低</li><li>用性能公式的一个子集去度量性能</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> computer science </category>
          
      </categories>
      
      
        <tags>
            
            <tag> computer science </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>math同余</title>
      <link href="/math-tong-yu/"/>
      <url>/math-tong-yu/</url>
      
        <content type="html"><![CDATA[<h3 id="同余"><a href="#同余" class="headerlink" title="同余"></a>同余</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>$a, b \in Z, m \in Z^+$，若有 $m | a - b$，则称 $a, b$ 模 $m$ 同余，记作 $a \equiv b \quad (mod \; m)$</p><h4 id="判断"><a href="#判断" class="headerlink" title="判断"></a>判断</h4><ol><li><p>$a \equiv b \quad (mod \; m) \iff \exists q \in Z, a = b + q \cdot m$</p></li><li><p>模同余是一种等价关系，即有<strong>自反性</strong>、<strong>对称性</strong>、和<strong>传递性</strong></p></li><li><p>$a \equiv b \quad (mod \; m) \iff$ $a, b$ 被 $m$ 除的余数相同</p></li><li><p>同余做<strong>加法</strong>和<strong>乘法</strong>之后仍然同余</p></li></ol><h4 id="性质"><a href="#性质" class="headerlink" title="性质"></a>性质</h4><ul><li>设 $d \cdot a \equiv d \cdot b \quad (mod \; m)$，若 $(d,m) = 1$，则 $a \equiv b \quad (mod \; m)$</li><li>$m \in Z^+$，设 $a \equiv b \quad (mod \; m)$，$d &gt; 0$，则 $a \cdot d \equiv b \cdot d \quad (mod \; d \cdot m)$</li><li>设 $a \equiv b \quad (mod \; m)$，若 $d | (a, b, m)$，则 $\frac{a}{d} \equiv \frac{b}{d} \quad (mod \; \frac{m}{d})$</li><li>设 $a \equiv b \quad (mod \; m)$，若 $d | m$，则 $a \equiv b \quad (mod \; d)$</li><li>设 $a \equiv b \quad (mod \; m_i)$，则 $a \equiv  b \quad mod([m_1, … m_k])$</li><li>设 $a \equiv b \quad (mod \; m)$，则 $(a, m) = (b, m)$</li></ul><h3 id="剩余类和完全剩余系"><a href="#剩余类和完全剩余系" class="headerlink" title="剩余类和完全剩余系"></a>剩余类和完全剩余系</h3><h4 id="剩余类与剩余"><a href="#剩余类与剩余" class="headerlink" title="剩余类与剩余"></a>剩余类与剩余</h4><p>$m \in Z^+$，$\forall a \in Z$，令 $C_a = \lbrace c | c \in Z, c \equiv a (mod \; m) \rbrace$，则 $C_a$ 称为模 $m$ 的 $a$ 的<strong>剩余类</strong>，一个剩余类中的任一数称为该类的<strong>剩余</strong>或<strong>代表元</strong>，若 $r_0, r_1, \dots, r_n \in Z$ 且任意两个数都不在同一个剩余类中，则称其为模 $m$ 的一个完全剩余系</p><p>通常将模 $m$ 的所有剩余类记作 $Z/mZ$，模 $m$ 的所有简化剩余类记作 $(Z/mZ)^*$</p><h4 id="完全剩余系"><a href="#完全剩余系" class="headerlink" title="完全剩余系"></a>完全剩余系</h4><p>$r_0, r_1, \dots ,r_n$ 为模 $m$ 的一个完全剩余系 $\iff$ 模 $m$ 两两不同余</p><p>一些特殊的完全剩余系：<strong>最小非负完全剩余系</strong>、<strong>最小正完全剩余系</strong>、<strong>最大非正完全剩余系</strong>、<strong>最大负完全剩余系</strong>、<strong>绝对值最小完全剩余系</strong> </p><h4 id="性质-1"><a href="#性质-1" class="headerlink" title="性质"></a>性质</h4><ul><li><font color="red">$m \in Z^+, (a, m) = 1$，$\forall b \in Z$，若 $k$ 遍历模 $m$ 的一个完全剩余系，则 $a \cdot k + b$ 也遍历模 $m$ 的一个完全剩余系</font></li><li>$(m_1, m_2) = 1$，若 $k_1, k_2$ 分别遍历模 $m_1, m_2$ 的完全剩余系，则 $m_2 \cdot k_1 + m_1 \cdot k_2$ 遍历模 $m_1 \cdot m_2$ 的完全剩余系</li></ul><h3 id="简化剩余系与欧拉函数"><a href="#简化剩余系与欧拉函数" class="headerlink" title="简化剩余系与欧拉函数"></a>简化剩余系与欧拉函数</h3><h4 id="欧拉函数"><a href="#欧拉函数" class="headerlink" title="欧拉函数"></a>欧拉函数</h4><p>欧拉函数 $\psi(m)$，指 $0, 1, \dots, m-1$ 中与 $m$ 互素的整数个数</p><h4 id="简化剩余类"><a href="#简化剩余类" class="headerlink" title="简化剩余类"></a>简化剩余类</h4><p>若剩余类 $C_a$ 中的一个剩余 $a$ 满足 $(a, m)=1$，则称该类为<strong>简化剩余类</strong>，简化剩余类中的剩余称为<strong>简化剩余</strong>，从每个简化剩余类中任取一个整数组成的集合称为<strong>简化剩余系</strong></p><p><strong>注：</strong>由定义可知 $|(Z/mZ)^*|=\psi(m)$</p><p>同剩余系，简化剩余也可分为一些特殊的简化剩余系</p><h4 id="性质-2"><a href="#性质-2" class="headerlink" title="性质"></a>性质</h4><ul><li><p>$(a, m) = 1$，如果 $x$ 遍历模 $m$ 的一个简化剩余系，则 $a \cdot x$ 也遍历模 $m$ 的一个简化剩余系</p></li><li><p>$(a, m) = 1$，存在 $a^{-1} \in Z$，且 $1 \le a^{-1} &lt; m$，使得 $a \cdot a^{-1} \equiv 1 \quad (mod \; m)$ </p><ul><li>由 Bezout 等式立即得到结论成立</li></ul></li><li><p>$(m_1, m_2) = 1$，如果 $k_1, k_2$ 分别遍历模 $m_1,m_2$ 的简化剩余系，则 $m_2 \cdot k_1 + m_1 \cdot k_2$ 遍历模 $m_1 \cdot m_2$ 的简化剩余系</p></li><li><p><font color="red">$(m, n) = 1$，则 $\psi(mn)=\psi(m) \cdot \psi(n)$</font></p><ul><li>考虑 $xm + yn$ 由上一条定理立证</li></ul></li><li><p>设 $n = \Pi p_i^{\alpha_i}$，则 $\psi(n) = n \cdot \Pi(1-\frac{1}{p_i})$</p></li><li><p>$$<br>\sum_{d|m} \psi(d) = m<br>$$</p><ul><li><font color="red">该定理将用于原根的构造</font></li><li>$1, \dots , m$ 中的每一个整数按照与 $m$ 的最大公因数进行分类</li></ul></li></ul><h3 id="欧拉定理和费马小定理"><a href="#欧拉定理和费马小定理" class="headerlink" title="欧拉定理和费马小定理"></a>欧拉定理和费马小定理</h3><h4 id="欧拉定理"><a href="#欧拉定理" class="headerlink" title="欧拉定理"></a>欧拉定理</h4><p>若 $(a, m) = 1$，则有 $a^{\psi(m)} \equiv 1 \quad (mod \; m)$</p><h4 style="color:red;"> RSA  <p>设 $p, q$ 是两个不同的奇素数，$n = p \cdot q$，$a \in Z$ 且 $(a, n) = 1$，如果 $e$ 满足：<br>$$<br>1 &lt; e &lt; \psi(n), \quad (e, \psi(n)) = 1<br>$$<br>那么存在整数 $d$，使得 $e \cdot d \equiv 1 \quad (mod \; \psi(n))$，而且，对于整数<br>$$<br>a^e \equiv c \quad (mod \; n), \quad 1 &lt; c &lt; n<br>$$<br>有<br>$$<br>c^d \equiv a \quad (mod \; n)<br>$$<br>上述公钥为 $n,e$，私钥为 $p,q,d$，明文为 $a$，密文为 $c$</p><pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">GeneratePrime</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""generate prime by miller robin algorithm"""</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> judge_numbers<span class="token punctuation">:</span> Iterable<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> None<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># judge_numbers are numbers to test in miller robin algorithm</span>        <span class="token keyword">if</span> <span class="token operator">not</span> judge_numbers<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>judge_numbers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">}</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>judge_numbers <span class="token operator">=</span> judge_numbers    <span class="token keyword">def</span> <span class="token function">gen_nbit_prime</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">,</span> threshold<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""generate nbit length prime"""</span>        <span class="token comment" spellcheck="true"># support n &lt;= 1024</span>        <span class="token keyword">assert</span> n <span class="token operator">&lt;=</span> <span class="token number">1024</span>        lower_bound <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">**</span> n        upper_bound <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">**</span> <span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>        num <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">while</span> num <span class="token operator">&lt;</span> threshold<span class="token punctuation">:</span>            <span class="token comment" spellcheck="true"># keep odd</span>            p <span class="token operator">=</span> randint<span class="token punctuation">(</span>lower_bound<span class="token punctuation">,</span> upper_bound<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">1</span>            <span class="token keyword">if</span> self<span class="token punctuation">.</span>is_prime<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> p            num <span class="token operator">+=</span> <span class="token number">1</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"fail to find prime"</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">is_prime</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> bool<span class="token punctuation">:</span>        <span class="token keyword">if</span> p <span class="token operator">&amp;</span> <span class="token number">1</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>        <span class="token keyword">if</span> p <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">}</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">True</span>        <span class="token keyword">for</span> judge_num <span class="token keyword">in</span> self<span class="token punctuation">.</span>judge_numbers<span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>miller_robin_test<span class="token punctuation">(</span>p<span class="token punctuation">,</span> judge_num<span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token boolean">False</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    @staticmethod    <span class="token keyword">def</span> <span class="token function">miller_robin_test</span><span class="token punctuation">(</span>p<span class="token punctuation">:</span> int<span class="token punctuation">,</span> a<span class="token punctuation">:</span> int<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> bool<span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""miller robin algorithm to test if p is prime        More details can be found in wikipedia "https://en.wikipedia.org/wiki/Miller%E2%80%93Rabin_primality_test"        """</span>        <span class="token comment" spellcheck="true"># fermat theorem: a^p = a (mod p) if p is prime</span>        <span class="token comment" spellcheck="true"># here we use builtin function for efficiency</span>        <span class="token keyword">if</span> pow<span class="token punctuation">(</span>a<span class="token punctuation">,</span> p<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">!=</span> a<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>        n <span class="token operator">=</span> p <span class="token operator">-</span> <span class="token number">1</span>        <span class="token comment" spellcheck="true"># if x^2 = 1 (mod p) then, x = 1/p-1 (mod p)</span>        <span class="token keyword">while</span> n <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">:</span>            remainder <span class="token operator">=</span> pow<span class="token punctuation">(</span>a<span class="token punctuation">,</span> n<span class="token punctuation">,</span> p<span class="token punctuation">)</span>            <span class="token keyword">if</span> remainder <span class="token operator">not</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token boolean">False</span>            n <span class="token operator">//=</span> <span class="token number">2</span>        <span class="token keyword">return</span> <span class="token boolean">True</span><span class="token keyword">class</span> <span class="token class-name">RSA</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""RSA example    Description:        this implement 2.4.5 in chapter2    """</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> nbit<span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token number">65537</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        prime_gen <span class="token operator">=</span> GeneratePrime<span class="token punctuation">(</span><span class="token punctuation">)</span>        p <span class="token operator">=</span> prime_gen<span class="token punctuation">.</span>gen_nbit_prime<span class="token punctuation">(</span>nbit<span class="token punctuation">)</span>        q <span class="token operator">=</span> prime_gen<span class="token punctuation">.</span>gen_nbit_prime<span class="token punctuation">(</span>nbit<span class="token punctuation">)</span>        n <span class="token operator">=</span> p <span class="token operator">*</span> q        phi_n <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token number">-1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q<span class="token number">-1</span><span class="token punctuation">)</span>        d<span class="token punctuation">,</span> <span class="token operator">*</span>_ <span class="token operator">=</span> self<span class="token punctuation">.</span>extended_euclidean<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phi_n<span class="token punctuation">)</span>        d <span class="token operator">%=</span> phi_n        self<span class="token punctuation">.</span>private_key <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token string">"p"</span><span class="token punctuation">:</span> p<span class="token punctuation">,</span>            <span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">,</span>            <span class="token string">"phi_n"</span><span class="token punctuation">:</span> phi_n<span class="token punctuation">,</span>            <span class="token string">"d"</span><span class="token punctuation">:</span> d        <span class="token punctuation">}</span>        self<span class="token punctuation">.</span>public_key <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token string">"n"</span><span class="token punctuation">:</span> n<span class="token punctuation">,</span>            <span class="token string">"e"</span><span class="token punctuation">:</span> e        <span class="token punctuation">}</span>    <span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""encrypt plaintext a with public key e"""</span>        e <span class="token operator">=</span> self<span class="token punctuation">.</span>public_key<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"e"</span><span class="token punctuation">)</span>        n <span class="token operator">=</span> self<span class="token punctuation">.</span>public_key<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"n"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> pow<span class="token punctuation">(</span>a<span class="token punctuation">,</span> e<span class="token punctuation">,</span> n<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span>        d <span class="token operator">=</span> self<span class="token punctuation">.</span>private_key<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"d"</span><span class="token punctuation">)</span>        n <span class="token operator">=</span> self<span class="token punctuation">.</span>public_key<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"n"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> pow<span class="token punctuation">(</span>c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> n<span class="token punctuation">)</span>    @staticmethod    <span class="token keyword">def</span> <span class="token function">extended_euclidean</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""use extended euclidean algorithm to calculate s, t, k, s.t. sa + tb = k = (a, b)"""</span>        quotients <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        q<span class="token punctuation">,</span> r1 <span class="token operator">=</span> divmod<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>        r2 <span class="token operator">=</span> b        quotients<span class="token punctuation">.</span>append<span class="token punctuation">(</span>q<span class="token punctuation">)</span>        <span class="token keyword">while</span> r1 <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>            q<span class="token punctuation">,</span> r <span class="token operator">=</span> divmod<span class="token punctuation">(</span>r2<span class="token punctuation">,</span> r1<span class="token punctuation">)</span>            r2 <span class="token operator">=</span> r1            r1 <span class="token operator">=</span> r            quotients<span class="token punctuation">.</span>append<span class="token punctuation">(</span>q<span class="token punctuation">)</span>        s<span class="token punctuation">:</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>        t<span class="token punctuation">:</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>quotients<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            s<span class="token punctuation">.</span>append<span class="token punctuation">(</span>quotients<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token operator">-</span>s<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>            t<span class="token punctuation">.</span>append<span class="token punctuation">(</span>quotients<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token operator">-</span>t<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> s<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> r2</code></pre></h4><h4 id="费马小定理"><a href="#费马小定理" class="headerlink" title="费马小定理"></a>费马小定理</h4><p>$p$ 是一个素数，$\forall a,t,k \in Z$，有 $a^{t + k \cdot (p-1)} \equiv a^t \quad (mod \; p)$</p><h4 id="Wilson-定理"><a href="#Wilson-定理" class="headerlink" title="Wilson 定理"></a>Wilson 定理</h4><p>$p$ 是一个素数，则有<br>$$<br>(p-1)! \equiv -1 \quad (mod \; p)<br>$$</p><h3 style="color: red;">模重复平方计算法</h3><p>计算 $b^n \; (mod \; m)$ 的步骤：</p><ul><li>将 $n$ 表示成二进制 $n=(n_{k-1}n_{k-2} \cdots n_0)_2$</li><li>在模 $m$ 下计算 $b_0=b,b_1=b_0^2, \dots, b_{k-1}=b_{k-2}^2$</li><li>在模 $m$ 下计算 $a_0 = b_0^{n_0}, a_t=a_{t-1} \cdot b_t^{n_t}, \; \; t \in [1, k-1]$</li><li>$a_{k-1}$ 即为结果</li></ul><p>例子：计算 $312^{13} \; (mod \; 667)$<br>$$<br>\begin{align}&amp; 13 = (1101)_2 \\&amp; b_0 = b = 312； b_1 = b_0^2 = 629； b_2 = b_1^2 = 110；b_3 = b_2^2 = 94 \\&amp; a_0 = b_0^{n_0} = 312；a_1 = a_0 \cdot b_1^{n_1} = 312；a_2 = a_1 \cdot b_2^{n_2} = 303；a_3 = a_2 \cdot b_3^{n_3} = 468 \end{align}<br>$$<br>故结果为 $468$</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">exponentiation_by_squaring</span><span class="token punctuation">(</span>b<span class="token punctuation">:</span> int<span class="token punctuation">,</span> e<span class="token punctuation">:</span> int<span class="token punctuation">,</span> m<span class="token punctuation">:</span> int<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> int<span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""calculate non-negative integer k that satisfies b^e = k (mod m)    Description:        This function implement exponentiation mod in chapter2    Args:        b: the base integer        e: the exponent integer        m: the modulus    Returns:        the non-negative integer k that satisfies b^e = k (mod m) and 0 &lt;= k &lt; m    """</span>    <span class="token keyword">def</span> <span class="token function">integer_to_binary</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> List<span class="token punctuation">[</span>int<span class="token punctuation">]</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""change non-negative integer s to binary"""</span>        bin_array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">while</span> s <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>            bin_array<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span>            s <span class="token operator">//=</span> <span class="token number">2</span>        <span class="token comment" spellcheck="true"># the binary is expressed as a_0 + a_1*2 + ... + a_n*2^n</span>        <span class="token keyword">return</span> bin_array    bin_list <span class="token operator">=</span> integer_to_binary<span class="token punctuation">(</span>e<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># previously calculate b, b^2, b^4, ... in the case of module m</span>    previous_b_list<span class="token punctuation">:</span> list <span class="token operator">=</span> <span class="token punctuation">[</span>b <span class="token operator">%</span> m<span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>bin_list<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        previous_b_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>previous_b_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">%</span> m<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># calculate k</span>    k <span class="token operator">=</span> b <span class="token operator">**</span> bin_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">%</span> m    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>bin_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> bin_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>            k <span class="token operator">=</span> k <span class="token operator">*</span> previous_b_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">%</span> m    <span class="token keyword">return</span> k</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> math </category>
          
      </categories>
      
      
        <tags>
            
            <tag> math </tag>
            
            <tag> infomation security </tag>
            
            <tag> course </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fastapi Query Parameters and String Validations</title>
      <link href="/fastapi-query-parameters-and-string-validations/"/>
      <url>/fastapi-query-parameters-and-string-validations/</url>
      
        <content type="html"><![CDATA[<h3 id="Query-Parameters-and-String-Validations"><a href="#Query-Parameters-and-String-Validations" class="headerlink" title="Query Parameters and String Validations"></a>Query Parameters and String Validations</h3><p><strong>FastAPI</strong> 允许对参数进行验证和声明附加信息</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPIapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>q<span class="token punctuation">:</span> str <span class="token operator">=</span> None<span class="token punctuation">)</span><span class="token punctuation">:</span>    results <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> <span class="token string">"Bar"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>    <span class="token keyword">if</span> q<span class="token punctuation">:</span>        results<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> results</code></pre><p>参数 <code>q</code> 的类型是 <code>str</code>，默认值为 <code>None</code>，因此是可选的</p><h3 id="Additional-validation"><a href="#Additional-validation" class="headerlink" title="Additional validation"></a>Additional validation</h3><p>下面的例子强制要求即使 <code>q</code> 是可选的，但是只要被提供，长度就不能超过 50 个字符</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Queryapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>q<span class="token punctuation">:</span> str <span class="token operator">=</span> Query<span class="token punctuation">(</span>None<span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    results <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> <span class="token string">"Bar"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>    <span class="token keyword">if</span> q<span class="token punctuation">:</span>        results<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> results</code></pre><p><strong>步骤</strong>：</p><ol><li>导入 <code>Query</code></li><li>使用 <code>Query</code> 作为函数参数的默认值：<ul><li><code>Query</code> 的第一个参数作为原函数参数的默认值</li><li>可以添加其他关键字参数来验证数据，如 <code>max_length</code> ，<code>min_length</code>，<code>regex</code> 等</li><li><code>Query</code> 显式表明了该参数为<strong>查询参数</strong></li><li>如果 <code>Query</code> 有默认值，那么该参数是可选的</li><li>如果期望声明必须参数，可以使用 <code>...</code> 作为 <code>Query</code>第一个参数</li></ul></li></ol><h3 id="Query-parameter-list-multiple-values"><a href="#Query-parameter-list-multiple-values" class="headerlink" title="Query parameter list / multiple values"></a>Query parameter list / multiple values</h3><p>当使用 <code>Query</code> 显示定义查询参数时，可以声明该参数接受值列表</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Queryapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>q<span class="token punctuation">:</span> List<span class="token punctuation">[</span>str<span class="token punctuation">]</span> <span class="token operator">=</span> Query<span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    query_items <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span>    <span class="token keyword">return</span> query_items</code></pre><p>在上面的例子中，如果访问</p><p><code>http://localhost:8000/items/?q=foo&amp;q=bar</code></p><p>查询参数 <code>q</code> 的值是一个列表</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"q"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"foo"</span><span class="token punctuation">,</span>    <span class="token string">"bar"</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p><strong>注：</strong>当使用 <code>list</code> 类型声明查询查询参数时，必须使用 <code>Query</code>，否则会被解释成 <strong>request body</strong></p><h3 id="Query-parameter-list-multiple-values-with-defaults"><a href="#Query-parameter-list-multiple-values-with-defaults" class="headerlink" title="Query parameter list / multiple values with defaults"></a>Query parameter list / multiple values with defaults</h3><p>同样的，可以为 <code>list</code> 类型定义默认值</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Queryapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>q<span class="token punctuation">:</span> List<span class="token punctuation">[</span>str<span class="token punctuation">]</span> <span class="token operator">=</span> Query<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token string">"bar"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    query_items <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span>    <span class="token keyword">return</span> query_items</code></pre><p>如果访问</p><p><code>http://localhost:8000/items/</code></p><p>返回值为</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"q"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"foo"</span><span class="token punctuation">,</span>    <span class="token string">"bar"</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p><strong>注：</strong>在上述例子中，如果使用 <code>list</code> 代替 <code>list[str]</code>，那么 <strong>FastAPI</strong> 将不会做类型检查，例如</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Queryapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>q<span class="token punctuation">:</span> list <span class="token operator">=</span> Query<span class="token punctuation">(</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    query_items <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span>    <span class="token keyword">return</span> query_items</code></pre><h3 id="Declare-more-metadata"><a href="#Declare-more-metadata" class="headerlink" title="Declare more metadata"></a>Declare more metadata</h3><p>可以为参数添加更多的信息</p><p>这些信息将会被包含在自动生成的 <strong>OpenAPI</strong> 中，并且可以被用户文档界面和其他工具所使用</p><p><strong>注：</strong>不同的工具可能对 <strong>OpenAPI</strong> 的支持程度不同</p><p>下面是利用 <code>Query</code> 声明额外信息的例子</p><p>添加 <code>title</code></p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Queryapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>q<span class="token punctuation">:</span> str <span class="token operator">=</span> Query<span class="token punctuation">(</span>None<span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">"Query string"</span><span class="token punctuation">,</span> min_length<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    results <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> <span class="token string">"Bar"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>    <span class="token keyword">if</span> q<span class="token punctuation">:</span>        results<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> results</code></pre><p>添加 <code>description</code></p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Queryapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>    q<span class="token punctuation">:</span> str <span class="token operator">=</span> Query<span class="token punctuation">(</span>        None<span class="token punctuation">,</span>        title<span class="token operator">=</span><span class="token string">"Query string"</span><span class="token punctuation">,</span>        description<span class="token operator">=</span><span class="token string">"Query string for the items to search in the database that have a good match"</span><span class="token punctuation">,</span>        min_length<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    results <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> <span class="token string">"Bar"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>    <span class="token keyword">if</span> q<span class="token punctuation">:</span>        results<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> results</code></pre><h3 id="Alias-parameters"><a href="#Alias-parameters" class="headerlink" title="Alias parameters"></a>Alias parameters</h3><p>在 <code>Query</code> 中使用 <code>alias</code> 关键字可以为参数声明别名</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Queryapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>q<span class="token punctuation">:</span> str <span class="token operator">=</span> Query<span class="token punctuation">(</span>None<span class="token punctuation">,</span> alias<span class="token operator">=</span><span class="token string">"item-query"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    results <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> <span class="token string">"Bar"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>    <span class="token keyword">if</span> q<span class="token punctuation">:</span>        results<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> results</code></pre><p>在上述例子中 <code>item-query</code> 是 <code>q</code> 的别名，即访问：</p><p><code>http://127.0.0.1:8000/items/?item-query=foobaritems</code></p><p>相当于不使用别名访问</p><p><code>http://127.0.0.1:8000/items/?q=foobaritems</code></p><p><strong>注：</strong>使用别名之后将取代原名称，即声明别名 <code>item-query</code> 之后，只能通过上述第一个 URL 访问</p><h3 id="Deprecating-parameters"><a href="#Deprecating-parameters" class="headerlink" title="Deprecating parameters"></a>Deprecating parameters</h3><p>使用 <code>deprecated</code> 表明该参数将被废弃(仍可以使用，但在文档中会标注)</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Queryapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_items</span><span class="token punctuation">(</span>    q<span class="token punctuation">:</span> str <span class="token operator">=</span> Query<span class="token punctuation">(</span>        None<span class="token punctuation">,</span>        alias<span class="token operator">=</span><span class="token string">"item-query"</span><span class="token punctuation">,</span>        title<span class="token operator">=</span><span class="token string">"Query string"</span><span class="token punctuation">,</span>        description<span class="token operator">=</span><span class="token string">"Query string for the items to search in the database that have a good match"</span><span class="token punctuation">,</span>        min_length<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>        max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>        regex<span class="token operator">=</span><span class="token string">"^fixedquery$"</span><span class="token punctuation">,</span>        deprecated<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    results <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> <span class="token string">"Bar"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>    <span class="token keyword">if</span> q<span class="token punctuation">:</span>        results<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> results</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fastapi </tag>
            
            <tag> python </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python 函数参数</title>
      <link href="/python-han-shu-can-shu/"/>
      <url>/python-han-shu-can-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="可接受任意数量参数的函数"><a href="#可接受任意数量参数的函数" class="headerlink" title="可接受任意数量参数的函数"></a>可接受任意数量参数的函数</h3><p><strong>使用 * 参数，可以让一个函数接受任意数量的位置参数</strong></p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span></code></pre><p>在上述例子中，<code>args</code> 是一个由除 <code>arg</code> 以外所有位置参数组成的元组</p><p><strong>使用 ** 参数，可以让一个函数接受任意数量的关键字参数</strong></p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span></code></pre><p>在上述例子中，<code>kwargs</code> 是包含被传入进来的关键字参数字典</p><p><strong>同时使用 * 和 **，能够让函数接受任意数量的位置参数和关键字参数</strong></p><h3 id="只接受关键字参数的函数"><a href="#只接受关键字参数的函数" class="headerlink" title="只接受关键字参数的函数"></a>只接受关键字参数的函数</h3><p><strong>将参数放在 *参数或者单个 *后面</strong></p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span><span class="token keyword">def</span> <span class="token function">other_test</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">pass</span></code></pre><p>在上述例子中，<code>key</code> 必须为关键字参数</p><h3 id="仅限位置形参"><a href="#仅限位置形参" class="headerlink" title="仅限位置形参"></a>仅限位置形参</h3><p><strong>使用 <code>/</code> 指明某些函数的形参必须使用仅限位置而非关键字参数的形式</strong></p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">/</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">,</span> f<span class="token punctuation">)</span></code></pre><p>在上述例子中，<code>a</code>，<code>b</code> 为仅限位置形参，<code>c</code>，<code>d</code> 可以是位置形参也可以是关键字形参，<code>e</code> ，<code>f</code>必须为关键字形参</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Request Body</title>
      <link href="/fastapi-request-body/"/>
      <url>/fastapi-request-body/</url>
      
        <content type="html"><![CDATA[<h3 id="Request-Body"><a href="#Request-Body" class="headerlink" title="Request Body"></a>Request Body</h3><p>当需要从客户端(如浏览器)发送数据到 API 时，可以借助 <strong>request body</strong> </p><p><strong>request body</strong>：从客户端发送到 API 的数据</p><p><strong>response body</strong>：从 API 发送到客户端的数据</p><p>API 总是需要发送 <strong>response body</strong>，但是客户端并不一定需要发送 <strong>request body</strong></p><p>借助 <strong>Pydantic</strong> 来声明 <strong>request body</strong></p><p><strong>注</strong>：</p><ul><li><p>通常不用 <code>GET</code> 发送 <strong>request body</strong> (实际上 <code>GET</code> <a href="https://juejin.im/entry/5badb020f265da0ac962abf2" target="_blank" rel="noopener">好像也是可以发送的</a>)</p></li><li><p>通常用：<code>POST</code>(最常见)，<code>PUT</code>，<code>DELETE</code>，<code>PATCH</code> 中的一种发送数据</p></li></ul><h3 id="Pydantic-example"><a href="#Pydantic-example" class="headerlink" title="Pydantic example"></a>Pydantic example</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>    name<span class="token punctuation">:</span> str    description<span class="token punctuation">:</span> str <span class="token operator">=</span> None    price<span class="token punctuation">:</span> float    tax<span class="token punctuation">:</span> float <span class="token operator">=</span> Noneapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> Item<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> item</code></pre><p>声明 <strong>request body</strong> 步骤：</p><ol><li>导入 <code>BaseModel</code> </li><li>定义数据模型并继承于 <code>BaseModel</code>：<ul><li>要注意声明 Python types</li><li>和声明查询参数一样，当模型的属性有默认值时，该属性不是必须的，否则是必须的，用 <code>None</code> 声明可选参数</li></ul></li><li>声明数据模型为参数：<ul><li>类似路径参数和查询参数一样，将其加入到函数参数中，并声明类型为自定义的数据类型</li></ul></li></ol><h3 id="Results"><a href="#Results" class="headerlink" title="Results"></a>Results</h3><p>使用上述的声明，<strong>FastAPI</strong> 将会：</p><ul><li>以 JSON 格式读取 <strong>request body</strong></li><li>将数据转化为相应的类型(如果需要的话)</li><li>验证数据：<ul><li>如果不合法，将会返回错误信息</li></ul></li><li>以定义的数据类型返回接受的数据，在上述例子中，<strong>request body</strong> 被转化为 Item 类型：<ul><li>如果在函数中声明了定义的数据类型，还将获得 IDE 支持</li></ul></li><li>为模型自动生成 JSON 模式定义</li><li>这些协议将作为自动生成的 <strong><a href="http://127.0.0.1:8000/openapi.json" target="_blank" rel="noopener">OpenAPI</a></strong> 的协议，并用作文档的自动生成</li></ul><h3 id="Automatic-docs"><a href="#Automatic-docs" class="headerlink" title="Automatic docs"></a>Automatic docs</h3><p>自定义模型的 JSON 协议将会作为自动生成 <strong>OpenAPI</strong> 协议的一部分，并且会通过交互式 API 文档展现</p><p>它们也会被用在每个需要path operation的 API 文档上</p><h3 id="Editor-support"><a href="#Editor-support" class="headerlink" title="Editor support"></a>Editor support</h3><p>IDE 将支持类型提示和自动补全，以及错误检查</p><h3 id="Use-the-model"><a href="#Use-the-model" class="headerlink" title="Use the model"></a>Use the model</h3><p>在函数中，可以直接访问所有数据模型的属性(和正常的访问没有区别)</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>    name<span class="token punctuation">:</span> str    description<span class="token punctuation">:</span> str <span class="token operator">=</span> None    price<span class="token punctuation">:</span> float    tax<span class="token punctuation">:</span> float <span class="token operator">=</span> Noneapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>item<span class="token punctuation">:</span> Item<span class="token punctuation">)</span><span class="token punctuation">:</span>    item_dict <span class="token operator">=</span> item<span class="token punctuation">.</span>dict<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> item<span class="token punctuation">.</span>tax<span class="token punctuation">:</span>        price_with_tax <span class="token operator">=</span> item<span class="token punctuation">.</span>price <span class="token operator">+</span> item<span class="token punctuation">.</span>tax        item_dict<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"price_with_tax"</span><span class="token punctuation">:</span> price_with_tax<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> item_dict</code></pre><h3 id="Request-body-path-parameters"><a href="#Request-body-path-parameters" class="headerlink" title="Request body + path parameters"></a>Request body + path parameters</h3><p>可以同时声明路径参数和 <strong>request body</strong></p><p><strong>FastAPI</strong> 能够自动识别函数参数中从路径中得到的<strong>路径参数</strong>和 <strong>request body</strong> 中获得的 <strong>Pydantic models</strong></p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>    name<span class="token punctuation">:</span> str    description<span class="token punctuation">:</span> str <span class="token operator">=</span> None    price<span class="token punctuation">:</span> float    tax<span class="token punctuation">:</span> float <span class="token operator">=</span> Noneapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"/items/{item_id}"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> int<span class="token punctuation">,</span> item<span class="token punctuation">:</span> Item<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">,</span> <span class="token operator">**</span>item<span class="token punctuation">.</span>dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h3 id="Request-body-path-query-parameters"><a href="#Request-body-path-query-parameters" class="headerlink" title="Request body + path + query parameters"></a>Request body + path + query parameters</h3><p>可以同时声明路径参数、<strong>request body</strong> 以及查询参数</p><p><strong>FastAPI</strong> 能够自动识别它们</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token keyword">class</span> <span class="token class-name">Item</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>    name<span class="token punctuation">:</span> str    description<span class="token punctuation">:</span> str <span class="token operator">=</span> None    price<span class="token punctuation">:</span> float    tax<span class="token punctuation">:</span> float <span class="token operator">=</span> Noneapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">"/items/{item_id}"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> int<span class="token punctuation">,</span> item<span class="token punctuation">:</span> Item<span class="token punctuation">,</span> q<span class="token punctuation">:</span> str <span class="token operator">=</span> None<span class="token punctuation">)</span><span class="token punctuation">:</span>    result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">,</span> <span class="token operator">**</span>item<span class="token punctuation">.</span>dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    <span class="token keyword">if</span> q<span class="token punctuation">:</span>        result<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> result</code></pre><p><strong><font color="red">函数参数的识别遵循：</font></strong></p><ul><li>如果参数出现在 <strong>path</strong> 中，则为路径参数</li><li>如果参数具有单一的类型，则为查询参数</li><li>如果被声明为 <strong>Pydantic model</strong>，则为 <strong>request body</strong></li></ul><h3 id="Without-Pydantic"><a href="#Without-Pydantic" class="headerlink" title="Without Pydantic"></a>Without Pydantic</h3><p>可以使用 <strong>Body parameters</strong> 代替 <strong>Pydantic model</strong></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fastapi </tag>
            
            <tag> python </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Query Parameters</title>
      <link href="/fastapi-query-parameters/"/>
      <url>/fastapi-query-parameters/</url>
      
        <content type="html"><![CDATA[<h3 id="Query-Parameters"><a href="#Query-Parameters" class="headerlink" title="Query Parameters"></a>Query Parameters</h3><p>当声明的函数参数不是路径参数的一部分时，它们会被自动的解释为<a href="https://en.wikipedia.org/wiki/Query_string" target="_blank" rel="noopener">查询参数</a>(可以直观的理解为 URL 中 ? 后面，以 &amp; 分割的键值对)</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPIapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>fake_items_db <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"item_name"</span><span class="token punctuation">:</span> <span class="token string">"Foo"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"item_name"</span><span class="token punctuation">:</span> <span class="token string">"Bar"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"item_name"</span><span class="token punctuation">:</span> <span class="token string">"Baz"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_item</span><span class="token punctuation">(</span>skip<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> fake_items_db<span class="token punctuation">[</span>skip <span class="token punctuation">:</span> skip <span class="token operator">+</span> limit<span class="token punctuation">]</span></code></pre><p>在上述例子中，如果访问 <code>http://127.0.0.1:8000/items/?skip=0&amp;limit=10</code> ，则查询参数为：</p><ul><li>skip：值为 0</li><li>limit：值为 10</li></ul><p>查询参数作为 URL 的一部分，默认是<strong>字符串</strong>类型，如果被声明为其他的 python 类型，例如在上面的例子中被声明为 <code>int</code> ，则会被自动转化成整数类型并进行类型检查</p><p><strong>适用于路径参数的过程同样适用于查询参数</strong>：</p><ul><li>编辑器支持</li><li>数据解析</li><li>数据验证</li><li>自动文档</li></ul><h3 id="Defaults"><a href="#Defaults" class="headerlink" title="Defaults"></a>Defaults</h3><p>由于查询参数不是路径中固定的一部分，因此它们是可选的，并且可以有默认值</p><p>在上述例子中，访问 <code>http://127.0.0.1:8000/items/</code> 和访问 <code>http://127.0.0.1:8000/items/?skip=0&amp;limit=10</code> 是等价的</p><p>，但是如果访问 <code>http://127.0.0.1:8000/items/?skip=20</code> ，则查询参数为：</p><ul><li>skip：20</li><li>limit：10</li></ul><h3 id="Optional-parameters"><a href="#Optional-parameters" class="headerlink" title="Optional parameters"></a>Optional parameters</h3><p>同样的，可以通过将默认值指定为 <code>None</code> 来声明<strong>可选</strong>查询参数</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPIapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/{item_id}"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> str<span class="token punctuation">,</span> q<span class="token punctuation">:</span> str <span class="token operator">=</span> None<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> q<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">,</span> <span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">}</span></code></pre><p>在上述例子中，参数 <code>q</code> 是可选的，并且默认值是 <code>None</code></p><p><strong>注</strong>：<strong>FastAPI</strong> 可以自动识别 <code>item_id</code> 为路径参数，<code>q</code> 是可选参数</p><h3 id="Query-parameter-type-conversion"><a href="#Query-parameter-type-conversion" class="headerlink" title="Query parameter type conversion"></a>Query parameter type conversion</h3><p>同样可以声明 <code>bool</code> 类型，它们也会被自动转换</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPIapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/{item_id}"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> str<span class="token punctuation">,</span> q<span class="token punctuation">:</span> str <span class="token operator">=</span> None<span class="token punctuation">,</span> short<span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    item <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">}</span>    <span class="token keyword">if</span> q<span class="token punctuation">:</span>        item<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">not</span> short<span class="token punctuation">:</span>        item<span class="token punctuation">.</span>update<span class="token punctuation">(</span>            <span class="token punctuation">{</span><span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"This is an amazing item that has a long description"</span><span class="token punctuation">}</span>        <span class="token punctuation">)</span>    <span class="token keyword">return</span> item</code></pre><p>在这个例子中，访问如下网址及其大小写变体，都有 <code>short=True</code> 成立，<strong>相反的意思</strong> 则为 <code>False</code></p><ul><li><p><code>http://127.0.0.1:8000/items/foo?short=1</code></p></li><li><p><code>http://127.0.0.1:8000/items/foo?short=True</code></p></li><li><p><code>http://127.0.0.1:8000/items/foo?short=true</code></p></li><li><p><code>http://127.0.0.1:8000/items/foo?short=on</code></p></li><li><p><code>http://127.0.0.1:8000/items/foo?short=yes</code></p></li></ul><p><strong>注</strong>：相反的意思指的是单词的意思相反，如 0-1，true-false 等，访问其他不可解析的路径时会报错</p><h3 id="Multiple-path-and-query-parameters"><a href="#Multiple-path-and-query-parameters" class="headerlink" title="Multiple path and query parameters"></a>Multiple path and query parameters</h3><p>可以同时声明多个路径参数和查询参数，<strong>FastAPI</strong> 知道如何进行选择</p><p>由于 <strong>FastAPI</strong> 是根据参数的名字来判断的，因此对参数的声明顺序没有要求</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPIapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/users/{user_id}/items/{item_id}"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_user_item</span><span class="token punctuation">(</span>    user_id<span class="token punctuation">:</span> int<span class="token punctuation">,</span> item_id<span class="token punctuation">:</span> str<span class="token punctuation">,</span> q<span class="token punctuation">:</span> str <span class="token operator">=</span> None<span class="token punctuation">,</span> short<span class="token punctuation">:</span> bool <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    item <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">,</span> <span class="token string">"owner_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">}</span>    <span class="token keyword">if</span> q<span class="token punctuation">:</span>        item<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"q"</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">not</span> short<span class="token punctuation">:</span>        item<span class="token punctuation">.</span>update<span class="token punctuation">(</span>            <span class="token punctuation">{</span><span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"This is an amazing item that has a long description"</span><span class="token punctuation">}</span>        <span class="token punctuation">)</span>    <span class="token keyword">return</span> item</code></pre><h3 id="Required-query-parameters"><a href="#Required-query-parameters" class="headerlink" title="Required query parameters"></a>Required query parameters</h3><p>当声明的非路径参数(目前只介绍了查询参数)有默认值时，它不是必须的</p><p>如果只想设置可选参数而不指定特定值，则可以设置默认值为 <code>None</code></p><p>如果想要让查询参数是必须的，只需要不指定默认值</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPIapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/{item_id}"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_user_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> str<span class="token punctuation">,</span> needy<span class="token punctuation">:</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>    item <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">,</span> <span class="token string">"needy"</span><span class="token punctuation">:</span> needy<span class="token punctuation">}</span>    <span class="token keyword">return</span> item</code></pre><p>在上面的例子中，<code>needy</code> 是类型为 <code>str</code> 的必须查询参数</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPIapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/{item_id}"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_user_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> str<span class="token punctuation">,</span> needy<span class="token punctuation">:</span> str<span class="token punctuation">,</span> skip<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> int <span class="token operator">=</span> None<span class="token punctuation">)</span><span class="token punctuation">:</span>    item <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">,</span> <span class="token string">"needy"</span><span class="token punctuation">:</span> needy<span class="token punctuation">,</span> <span class="token string">"skip"</span><span class="token punctuation">:</span> skip<span class="token punctuation">,</span> <span class="token string">"limit"</span><span class="token punctuation">:</span> limit<span class="token punctuation">}</span>    <span class="token keyword">return</span> item</code></pre><p>在上面的例子中，查询参数有 3 个：</p><ul><li>needy：类型为 <code>str</code> 的必选参数</li><li>skip：类型为 <code>int</code> 的可选参数，默认值为 0</li><li>limit：类型为 <code>int</code> 的可选参数</li></ul><p><strong>注</strong>：可以同上一节一样使用枚举变量</p><h3 id="Optional-type-declarations"><a href="#Optional-type-declarations" class="headerlink" title="Optional type declarations"></a>Optional type declarations</h3><p><strong>注</strong>：高级用法</p><p>在 <code>mypy</code> 中，如果使用：</p><pre class=" language-python"><code class="language-python">limit<span class="token punctuation">:</span> int <span class="token operator">=</span> None</code></pre><p>可能会出现错误：</p><pre class=" language-bash"><code class="language-bash">Incompatible types <span class="token keyword">in</span> assignment <span class="token punctuation">(</span>expression has <span class="token function">type</span> <span class="token string">"None"</span>, variable has <span class="token function">type</span> <span class="token string">"int"</span><span class="token punctuation">)</span></code></pre><p>可以通过 <code>Optional</code> 告知 <code>mypy</code> 值可以为 <code>None</code> ，例如：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optionallimit<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> None</code></pre><p>在路径声明中，可以这样写</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPIapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/{item_id}"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_user_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> str<span class="token punctuation">,</span> limit<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> None<span class="token punctuation">)</span><span class="token punctuation">:</span>    item <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">,</span> <span class="token string">"limit"</span><span class="token punctuation">:</span> limit<span class="token punctuation">}</span>    <span class="token keyword">return</span> item</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fastapi </tag>
            
            <tag> python </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>integer divisibility</title>
      <link href="/math-zheng-shu-de-ke-chu-xing/"/>
      <url>/math-zheng-shu-de-ke-chu-xing/</url>
      
        <content type="html"><![CDATA[<h3 id="整除"><a href="#整除" class="headerlink" title="整除"></a>整除</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>$a, b \in Z$ 且 $b \neq 0$ ，如果存在 $q \in Z$ 使得<br>$$<br>a=q \cdot b<br>$$<br>则称 $b$ 整除 $a$ 或者 $a$ 被 $b$ 整除，记作 $b | a$ ，$b$ 称为 $a$ 的因数，$a$ 称为 $b$ 的倍数</p><h4 id="性质："><a href="#性质：" class="headerlink" title="性质："></a>性质：</h4><ul><li><p>当 $b$ 遍历整数 $a$ 的所有因数时，$-b$ 和 $\frac{a}{b}$ 也遍历 $a$ 的因数</p></li><li><p>若 $a_1, …, a_n \in Z$ 都是 $c \in Z^*$ 的倍数，则他们的整系数线性组合也是 $c$ 的倍数，即 $\forall s_1, …, s_n \in Z$ 都有 $c | a_1s_1+…+a_ns_n$</p></li><li><p>若 $p$ 是素数，且 $p|a_1a_2 \cdots a_n$ ，则 $ \exists i, 1 \le i \le n$，$p|a_i$</p></li></ul><h3 id="素数"><a href="#素数" class="headerlink" title="素数"></a>素数</h3><h4 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h4><p>$n \in Z^* $ 且 $n \neq \pm 1$ 且 $n$ 只有因数 $\pm1、\pm n$ ，则 $n$ 称之为<strong>素数</strong>，通常情况下约定素数为正整数，记作 $p$</p><h4 id="性质：-1"><a href="#性质：-1" class="headerlink" title="性质："></a>性质：</h4><ul><li>合数的大于 $1$ 的最小正因数 $p$ 必然是素数，且 $p \le \sqrt{n}$ </li><li>等差数列 $qn+l$ 在 $(q, l)=1$ 时有无穷多个素数，<a href="https://zhuanlan.zhihu.com/p/57379991" target="_blank" rel="noopener">Dirichlet</a></li></ul><h4 id="Eratosthenes"><a href="#Eratosthenes" class="headerlink" title="Eratosthenes"></a>Eratosthenes</h4><p>依次删除 $\le \sqrt{N}$ 的所有素数的倍数，可求得所有不大于给定正整数 $N$ 的素数</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">eratosthenes</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""use eratosthenes sieve to count all prime number"""</span>    <span class="token keyword">if</span> n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">0</span>    sifter <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>int8<span class="token punctuation">)</span>    sifter<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>np<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> sifter<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>            <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n <span class="token operator">//</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                sifter<span class="token punctuation">[</span>i <span class="token operator">*</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">return</span> sifter<span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="欧几里得除法"><a href="#欧几里得除法" class="headerlink" title="欧几里得除法"></a>欧几里得除法</h3><h4 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h4><p>$a, b \in Z$ ，且 $b &gt; 0$，则 $\forall c \in Z$ 存在唯一的整数 $q, r$ 使得 $a=q \cdot b + r$，$c \le r &lt; c+b$ </p><p>其中 $q$ 称为 $a$ 被 $b$ 除所得的不完全商，$r$ 叫做 $a$ 被 $b$ 除所得的余数</p><ul><li>$c=0$ 时称 $r$ 为最小非负余数</li><li>$c=1$ 时称 $r$ 为最小正余数</li><li>$c=-b+1$ 时称 $r$ 为最大非正余数</li><li>$c=-b$ 时称 $r$ 为最大负余数</li><li>若 $c$ 满足 $-\frac{b}{2} \le r &lt; \frac{b}{2} ,, or ,, -\frac{b}{2} &lt; r \le \frac{b}{2}$ 时称 $r$ 为绝对值最小余数</li></ul><h3 id="整数的表示"><a href="#整数的表示" class="headerlink" title="整数的表示"></a>整数的表示</h3><p>$\forall b \in Z ,, and ,, b &gt; 1$ ，每个正整数 $n$ 在 $b$ 进制下的表示<a href="https://en.wikipedia.org/wiki/Euclidean_algorithm" target="_blank" rel="noopener">存在</a>且唯一，且 $n$ 的 $b$ 进制位数 $k=[\log_bn]+1$</p><h3 id="最大公因数"><a href="#最大公因数" class="headerlink" title="最大公因数"></a>最大公因数</h3><p>$d=(a_1,…,a_n)$ 称为最大公因数，如果：</p><ul><li>$d|a_1, …, d|a_n$</li><li>若 $e|a_1, …, e|a_n$，则 $e|d$</li></ul><h3 id="广义欧几里得除法"><a href="#广义欧几里得除法" class="headerlink" title="广义欧几里得除法"></a><font color="red">广义欧几里得除法</font></h3><img src="/img/math/2.png" alt="喵喵喵" style="zoom: 80%;"><h4 id="性质"><a href="#性质" class="headerlink" title="性质"></a>性质</h4><ul><li>$n \le 5logb$ ，<em>运用数学归纳法可以证明 $b$ 不小于 $fibonacci$ 的第 $n+1$ 项</em></li></ul><h3 id="Bezout-等式"><a href="#Bezout-等式" class="headerlink" title="Bezout 等式"></a><font color="red">Bezout 等式</font></h3><h4 id="定义-3"><a href="#定义-3" class="headerlink" title="定义"></a>定义</h4><p>$a, b \in Z^+$ ，存在整数 $s, t$ 使得 $sa+tb=(a,b)$  </p><h4 id="求整数-s-t-的方法"><a href="#求整数-s-t-的方法" class="headerlink" title="求整数 $s, t$ 的方法"></a>求整数 $s, t$ 的方法</h4><p><span id="1"><strong>方法一</strong></span>：首先根据广义欧几里得除法求出 $(a,b)=r_n$，带回并依次消去 $r_{n-1}, … ,r_1$</p><p>例如：$a=1859, b=1573$ ，求 $s, t$ 使得 $s \cdot a + t \cdot b=(a,b)$</p><p>根据欧几里得除法，我们有：<br>$$<br>\begin{align}&amp; 1859 = 1573 \times 1 + 286 \\ &amp; 1573 = 5 \times 286 + 143 \\ &amp; 286 = 2 \times 143\end{align}<br>$$<br>得到 $(a,b)=143$ ，带回<br>$$<br>\begin{align}143 &amp; = 1573 - 5 \times 286 \\ &amp; = 1573 - 5 \times (1859-1573) \\ &amp; = -5 \times 1859 + 6 \times 1573\end{align}<br>$$<br>于是 $s=-5, t=6$</p><p><strong>方法二</strong>：列表法</p><img src="/img/math/2.png" alt="喵喵喵" style="zoom:80%;"><p>依然使用<a href="#1">方法一</a>的例子</p><table><thead><tr><th align="center">$j$</th><th align="center">$s_j$</th><th align="center">$t_j$</th><th align="center">$q_{j+1}$</th><th align="center">$r_{j+1}$</th></tr></thead><tbody><tr><td align="center">-3</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">1859</td></tr><tr><td align="center">-2</td><td align="center">1</td><td align="center">0</td><td align="center"></td><td align="center">1573</td></tr><tr><td align="center">-1</td><td align="center">0</td><td align="center">1</td><td align="center">1</td><td align="center">286</td></tr><tr><td align="center">0</td><td align="center">$-s_{-1} \times q_0 + s_{-2} = 1$</td><td align="center">$-t_{-1} \times q_0 + t_{-2} = 1$</td><td align="center">5</td><td align="center">143</td></tr><tr><td align="center">1</td><td align="center">$-s_{0} \times q_1 + s_{-1} = -5$</td><td align="center">$-t_{0} \times q_1 + t_{-1} = 6$</td><td align="center">2</td><td align="center">0</td></tr></tbody></table><p>我们有 $s=s_1=-5, t=t_1=6, (a, b)=r_0=143$</p><p><strong>根据列表法求 s，t和(a,b)</strong></p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">extended_euclidean</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""use extended euclidean algorithm to calculate s, t, k, s.t. sa + tb = k = (a, b)"""</span>    quotients <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    q<span class="token punctuation">,</span> r1 <span class="token operator">=</span> divmod<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>    r2 <span class="token operator">=</span> b    quotients<span class="token punctuation">.</span>append<span class="token punctuation">(</span>q<span class="token punctuation">)</span>    <span class="token keyword">while</span> r1 <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>        q<span class="token punctuation">,</span> r <span class="token operator">=</span> divmod<span class="token punctuation">(</span>r2<span class="token punctuation">,</span> r1<span class="token punctuation">)</span>        r2 <span class="token operator">=</span> r1        r1 <span class="token operator">=</span> r        quotients<span class="token punctuation">.</span>append<span class="token punctuation">(</span>q<span class="token punctuation">)</span>    s<span class="token punctuation">:</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>    t<span class="token punctuation">:</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>quotients<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        s<span class="token punctuation">.</span>append<span class="token punctuation">(</span>quotients<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token operator">-</span>s<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>        t<span class="token punctuation">.</span>append<span class="token punctuation">(</span>quotients<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token operator">-</span>t<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> s<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> r2</code></pre><h4 id="性质-1"><a href="#性质-1" class="headerlink" title="性质"></a>性质</h4><ul><li>若 $a, b \in Z$ 且 $a^2 + b^2 \neq 0$，则<ul><li>$\forall m \in Z^+$ ，$(a \cdot m, b \cdot m)=(a, b) \cdot m$</li><li>若 $d \in Z^*$，且 $d|a, d|b$ ，则 $(\frac{a}{d}, \frac{b}{d})=\frac{(a,b)}{|d|}$<ul><li>特别的，若取 $d=(a,b)$，则我们可以构造两个互素的整数 $\frac{a}{d}, \frac{b}{d}$</li></ul></li></ul></li><li>$a, b, c \in Z, ,, b \ne 0, c \ne 0$ 且 $(a, c)=1$，则有 ：</li></ul><p>$$<br>(ab, c)=(b,c)<br>$$</p><ul><li>$a_i, c \in Z$ 且 $(a_i, c)=1$ 则有：</li></ul><p>$$<br>(\Pi_{i=1}^{n}a_i, c)=1<br>$$</p><ul><li>$a, b \in Z^+$，则 $(2^a-1, 2^b-1)=2^{(a,b)}-1$ </li></ul><p><strong>注</strong>：</p><blockquote><ol><li>Bezout 等式可扩展到 $n$ 维的情况</li><li>求 n 个数的最大公因数相当于递归的求两个数的最大公因数</li></ol></blockquote><h3 id="整数分解"><a href="#整数分解" class="headerlink" title="整数分解"></a>整数分解</h3><p>给定正合数 $n &gt; 1$，若 $ \exists a,b$ ，满足：<br>$$<br>n|a^2-b^2 \\ n \nmid a+b \\ n \nmid a-b<br>$$<br>则 $(n, a-b)$，$(n,a+b)$ 都是 $n$ 的真因数</p><h3 id="算术基本定理"><a href="#算术基本定理" class="headerlink" title="算术基本定理"></a><font color="red">算术基本定理</font></h3><p>任意整数 $n&gt;1$ 可以唯一的表示成<br>$$<br>n = p_1^{\alpha_1} \cdots p_n^{\alpha_s}, ,,,, \alpha_i &gt; 0,p_i&lt;p_j(i&lt;j)<br>$$<br><strong>注</strong>：利用算术基本定理，很多结论几乎是显而易见的</p><h4 id="性质-2"><a href="#性质-2" class="headerlink" title="性质"></a>性质</h4><ul><li>$n$ 的因数个数 $d(n)=\Pi(1+\alpha_i)$</li><li>$n$ 的所有因数的和：</li></ul><p>$$<br>\Pi(1 + p_i + \cdots p_i^{\alpha_i})=\Pi(\frac{p_i^{\alpha_i+1}-1}{p_i-1})<br>$$</p><ul><li>$a,b$ 是两个正整数，则存在整数 $a’|a, b’|b$ ，使得：</li></ul><p>$$<br>a’ \cdot b’=[a,b] \qquad (a’,b’)=1<br>$$</p><h3 id="素数定理"><a href="#素数定理" class="headerlink" title="素数定理"></a>素数定理</h3><p>设<br>$$<br>\pi(x) = \sum_{p \le x} 1<br>$$<br>则有：<br>$$<br>\frac{\ln 2}{3}\frac{x}{\ln x} &lt; \pi(x) &lt; 6 \ln 2 \frac{x}{\ln x}<br>$$<br>以及<br>$$<br>\lim_{x \rightarrow \infty} \cfrac{\pi(x)}{\cfrac{x}{\ln x}} = 1<br>$$</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> math </category>
          
      </categories>
      
      
        <tags>
            
            <tag> math </tag>
            
            <tag> infomation security </tag>
            
            <tag> course </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Path Parameters</title>
      <link href="/fastapi-path-parameters/"/>
      <url>/fastapi-path-parameters/</url>
      
        <content type="html"><![CDATA[<p><strong>path</strong> 中可以用 <strong>python</strong> 格式字符串的形式来声明变量，例如</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPIapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/{item_id}"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">}</span></code></pre><p>变量 <code>item_id</code> 会成为为函数的一个参数</p><h4 id="带类型的路径变量"><a href="#带类型的路径变量" class="headerlink" title="带类型的路径变量"></a>带类型的路径变量</h4><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPIapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/items/{item_id}"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_item</span><span class="token punctuation">(</span>item_id<span class="token punctuation">:</span> int<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"item_id"</span><span class="token punctuation">:</span> item_id<span class="token punctuation">}</span></code></pre><p><strong>给路径变量添加类型</strong>：</p><ul><li><p>有助于 IDE 的检查和代码自动补全</p></li><li><p><strong>FastAPI</strong> 可以根据声明的类型对变量自动解析 (将从<strong>http</strong>请求获得的字符串转化为 <strong>python data</strong>)</p><ul><li>例如向 <a href="http://127.0.0.1:8000/items/3" target="_blank" rel="noopener">http://127.0.0.1:8000/items/3</a> 发送请求会得到 <code>{"item_id":3}</code> 其中 3 是 <strong>python 整型变量</strong></li></ul></li><li><p><strong>FastAPI</strong> 可以根据声明的类型对<strong>数据进行验证</strong>，例如访问 <a href="http://127.0.0.1:8000/items/foo" target="_blank" rel="noopener">http://127.0.0.1:8000/items/foo</a> 会得到如下错误</p><ul><li><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"detail"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            <span class="token property">"loc"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token string">"path"</span><span class="token punctuation">,</span>                <span class="token string">"item_id"</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token property">"msg"</span><span class="token operator">:</span> <span class="token string">"value is not a valid integer"</span><span class="token punctuation">,</span>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"type_error.integer"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre></li></ul></li></ul><h4 id="Pydantic"><a href="#Pydantic" class="headerlink" title="Pydantic"></a>Pydantic</h4><p>所有的数据验证工作都是由 <strong><a href="https://pydantic-docs.helpmanual.io/" target="_blank" rel="noopener">Pydantic</a></strong> 提供的</p><h4 id="路径顺序"><a href="#路径顺序" class="headerlink" title="路径顺序"></a>路径顺序</h4><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPIapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/users/me"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_user_me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> <span class="token string">"the current user"</span><span class="token punctuation">}</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/users/{user_id}"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">:</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">}</span></code></pre><p>如果用 <code>/users/me</code> 表示当前用户 <code>/users/{user_id}</code> 表示特定用户，则 <code>/users/me</code> 需要放在前面，在 <strong>fastapi</strong> 中路径是按照声明的顺序来依次匹配的</p><h4 id="Predefined-values"><a href="#Predefined-values" class="headerlink" title="Predefined values"></a>Predefined values</h4><p>如果希望接收到预先定义的合法路径变量，可以使用 <strong><a href="https://docs.python.org/3/library/enum.html" target="_blank" rel="noopener">Enum</a></strong> </p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token comment" spellcheck="true"># 继承自 str 相当于给每一个属性声明 str 类型</span><span class="token keyword">class</span> <span class="token class-name">ModelName</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>    alexnet <span class="token operator">=</span> <span class="token string">"alexnet"</span>    resnet <span class="token operator">=</span> <span class="token string">"resnet"</span>    lenet <span class="token operator">=</span> <span class="token string">"lenet"</span>app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/model/{model_name}"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_model</span><span class="token punctuation">(</span>model_name<span class="token punctuation">:</span> ModelName<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># 枚举的值可以从类中得到</span>    <span class="token keyword">if</span> model_name <span class="token operator">==</span> ModelName<span class="token punctuation">.</span>alexnet<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"model_name"</span><span class="token punctuation">:</span> model_name<span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Deep Learning FTW!"</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true"># 枚举的值可以从实例中得到</span>    <span class="token keyword">if</span> model_name<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token string">"lenet"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"model_name"</span><span class="token punctuation">:</span> model_name<span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"LeCNN all the images"</span><span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"model_name"</span><span class="token punctuation">:</span> model_name<span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Have some residuals"</span><span class="token punctuation">}</span></code></pre><h4 id="包含路径的路径变量"><a href="#包含路径的路径变量" class="headerlink" title="包含路径的路径变量"></a>包含路径的路径变量</h4><p><strong>OpenAPI</strong> 不支持包含路径变量中包含路径，但是 <strong>FastAPI</strong> 借助 <strong>Starlette</strong> 的内置工具可以实现，并且生成的 API 文档仍然可用</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPIapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/files/{file_path:path}"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_file</span><span class="token punctuation">(</span>file_path<span class="token punctuation">:</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"file_path"</span><span class="token punctuation">:</span> file_path<span class="token punctuation">}</span></code></pre><p>在上面的例子中，如果希望 <code>file_path=/home/johndoe/myfile.txt</code> 则访问的地址为 <a href="http://127.0.0.1:8000/files//home/johndoe/myfile.txt" target="_blank" rel="noopener">http://127.0.0.1:8000/files//home/johndoe/myfile.txt</a></p><h4 id="Recap"><a href="#Recap" class="headerlink" title="Recap"></a>Recap</h4><p>使用 <strong>Python type declarations</strong> 可以：</p><ul><li>获得 IDE 支持，如错误检查，自动补全等</li><li>数据解析</li><li>数据验证</li><li>API 文档的注释</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fastapi </tag>
            
            <tag> python </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>First Steps</title>
      <link href="/fastapi-first-steps/"/>
      <url>/fastapi-first-steps/</url>
      
        <content type="html"><![CDATA[<h4 id="一个简单的例子"><a href="#一个简单的例子" class="headerlink" title="一个简单的例子"></a>一个简单的例子</h4><h5 id="main-py"><a href="#main-py" class="headerlink" title="main.py"></a>main.py</h5><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPIapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Hello World"</span><span class="token punctuation">}</span></code></pre><h5 id="启动-uvicorn-命令"><a href="#启动-uvicorn-命令" class="headerlink" title="启动 uvicorn 命令"></a>启动 uvicorn 命令</h5><pre class=" language-bash"><code class="language-bash">uvicorn main:app --reload</code></pre><ul><li>main：python 的模块，即文件 main.py</li><li>app：指 <code>python app=FastAPI()</code> 中的app</li><li>–reload：代码改变时重启服务器，<strong>只用于开发</strong></li></ul><h4 id="API-文档"><a href="#API-文档" class="headerlink" title="API 文档"></a>API 文档</h4><ul><li>交互式：位于 <a href="http://127.0.0.1:8000/docs" target="_blank" rel="noopener">http://127.0.0.1:8000/docs</a></li><li>参考文档：位于 <a href="http://127.0.0.1:8000/redoc" target="_blank" rel="noopener">http://127.0.0.1:8000/redoc</a></li></ul><h4 id="OpenAPI"><a href="#OpenAPI" class="headerlink" title="OpenAPI"></a>OpenAPI</h4><ul><li><strong>FastAPI</strong> 使用 <strong>OpenAPI</strong> 标准 (定义API协议的规范) 来生成定义API的 <em>协议</em> (对某些东西的抽象描述，而不是具体的实现)</li><li>可以在 <a href="http://127.0.0.1:8000/openapi.json" target="_blank" rel="noopener">http://127.0.0.1:8000/openapi.json</a> 查看自动生成的 <strong>OpenAPI</strong> 协议，该协议可以用来生成API文档和与前端、移动设备和物联网应用的代码(例如mock server？)</li></ul><h4 id="Recap"><a href="#Recap" class="headerlink" title="Recap"></a>Recap</h4><ul><li><strong>FastAPI</strong> 直接继承于 <strong>Starlette</strong> </li><li><strong>path</strong>：也称为 <strong>endpoint</strong> 或者 <strong>route</strong> ，指 URL 中从第一个 <code>/</code> 开始的部分</li><li><strong>Operation</strong>：指 HTTP 的方法，如 <code>POST</code>、<code>GET</code>、<code>PUT</code> 等</li><li><strong>FastAPI</strong> 可以将大多数的对象和模型自动转化为 <strong>JSON</strong> ，包括 ORMs</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fastapi </tag>
            
            <tag> python </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>v2ray-configure</title>
      <link href="/v2ray-configure/"/>
      <url>/v2ray-configure/</url>
      
        <content type="html"><![CDATA[<h4 id="记录一下怕自己忘记了"><a href="#记录一下怕自己忘记了" class="headerlink" title="记录一下怕自己忘记了"></a>记录一下怕自己忘记了</h4><p><a href="https://www.ecsoe.com/archives/38.html" target="_blank" rel="noopener">v2配置</a><br><a href="https://www.4spaces.org/speed-up-your-vps-with-bbr-plus/" target="_blank" rel="noopener">v2加速</a><br><a href="https://blog.sprov.xyz/2019/03/11/" target="_blank" rel="noopener">cdn加速</a><br><a href="https://clients.hostwinds.com/" target="_blank" rel="noopener">hostwind 服务器</a><br><a href="https://www.namesilo.com/" target="_blank" rel="noopener">namesilo 域名网站</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> v2ray </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>socket加密通信</title>
      <link href="/socket-jia-mi-tong-xin/"/>
      <url>/socket-jia-mi-tong-xin/</url>
      
        <content type="html"><![CDATA[<h3 id="编程思路："><a href="#编程思路：" class="headerlink" title="编程思路："></a>编程思路：</h3><ol><li>客户端和服务器端建立连接</li><li>客户端产生非对称密钥，将公钥传送给服务器端</li><li>服务器端通过公钥将密钥进行加密并传送给客户端</li><li>客户端接收到密钥并进行解密，双方开始通信</li></ol><hr><h3 id="背景资料："><a href="#背景资料：" class="headerlink" title="背景资料："></a>背景资料：</h3><ul><li>AES原理(图解密码技术第三章)</li><li>RSA原理(图解密码技术第五章)</li><li><a href="https://www.cnblogs.com/wangcq/p/3520400.html" target="_blank" rel="noopener">Socket通信原理</a></li></ul><hr><h3 id="代码部分"><a href="#代码部分" class="headerlink" title="代码部分"></a>代码部分</h3><p>注释已经非常详细了，这里就不再赘述。</p><hr><h4 id="异常类定义"><a href="#异常类定义" class="headerlink" title="异常类定义"></a>异常类定义</h4><pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">AuthenticationError</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> Errorinfo<span class="token punctuation">)</span><span class="token punctuation">:</span>        super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>errorinfo <span class="token operator">=</span> Errorinfo    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>errorinfo</code></pre><hr><h4 id="服务器端代码"><a href="#服务器端代码" class="headerlink" title="服务器端代码"></a>服务器端代码</h4><hr><h5 id="服务器类定义："><a href="#服务器类定义：" class="headerlink" title="服务器类定义："></a>服务器类定义：</h5><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> socket<span class="token keyword">import</span> rsa<span class="token keyword">import</span> pickle<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>fernet <span class="token keyword">import</span> Fernet<span class="token keyword">import</span> hashlib<span class="token keyword">from</span> errorclass <span class="token keyword">import</span> AuthenticationError<span class="token keyword">import</span> time<span class="token comment" spellcheck="true"># 使用图灵机器人的自动回复功能</span><span class="token keyword">from</span> tlrobot <span class="token keyword">import</span> get_reply<span class="token keyword">class</span> <span class="token class-name">Server</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># 用来标记同时连接的客户端的数量</span>    number <span class="token operator">=</span> <span class="token number">0</span>    <span class="token comment" spellcheck="true"># 默认的最大等待数量为5</span>    <span class="token comment" spellcheck="true"># 默认使用本机的ip地址和8080端口</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> backlog<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> addr<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># 默认使用AF_INET协议族，即ipv4地址和端口号的组合以及tcp协议</span>        self<span class="token punctuation">.</span>serverSocket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 绑定监听的ip地址和端口号</span>        self<span class="token punctuation">.</span>serverSocket<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 开始等待</span>        self<span class="token punctuation">.</span>serverSocket<span class="token punctuation">.</span>listen<span class="token punctuation">(</span>backlog<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 该函数需要并行处理</span>    <span class="token keyword">def</span> <span class="token function">link_one_client</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># 获取客户端对象和客户端地址</span>        clientSocket<span class="token punctuation">,</span> addr <span class="token operator">=</span> self<span class="token punctuation">.</span>serverSocket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 客户端数量加1</span>        Server<span class="token punctuation">.</span>number <span class="token operator">=</span> Server<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span>        <span class="token comment" spellcheck="true"># 标记当前客户端编号</span>        now_number <span class="token operator">=</span> Server<span class="token punctuation">.</span>number        <span class="token comment" spellcheck="true"># 打印</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"和客户端{0}建立连接\n目标主机地址为：{1}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>now_number<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 接受客户端传递的公钥</span>        <span class="token comment" spellcheck="true"># 这里可以加一个哈希函数检验公钥的正确性！</span>        <span class="token comment" spellcheck="true"># 运用pickle进行反序列化</span>        publicKeyPK<span class="token punctuation">,</span> pubKeySha256 <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>clientSocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>publicKeyPK<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> pubKeySha256<span class="token punctuation">:</span>            <span class="token keyword">raise</span> AuthenticationError<span class="token punctuation">(</span><span class="token string">"密钥被篡改！"</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            publicKey <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>publicKeyPK<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"已接受公钥"</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 下面是用公钥加密对称密钥并传递的过程</span>        <span class="token comment" spellcheck="true"># 产生用于对称加密的密钥</span>        sym_key <span class="token operator">=</span> Fernet<span class="token punctuation">.</span>generate_key<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 用pickle进行序列化用来进行网络传输</span>        <span class="token comment" spellcheck="true"># 对密钥进行hash保证其准确性</span>        en_sym_key <span class="token operator">=</span> rsa<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sym_key<span class="token punctuation">)</span><span class="token punctuation">,</span> publicKey<span class="token punctuation">)</span>        en_sym_key_sha256 <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>en_sym_key<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"正在加密传送密钥"</span><span class="token punctuation">)</span>        clientSocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">(</span>en_sym_key<span class="token punctuation">,</span>en_sym_key_sha256<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 这里可以添加密钥交换成功的函数</span>        <span class="token comment" spellcheck="true"># 初始化加密对象</span>        f <span class="token operator">=</span> Fernet<span class="token punctuation">(</span>sym_key<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 下面使用对称密钥进行加密对话的过程</span>        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true"># 接收到的加密消息</span>            en_recvData <span class="token operator">=</span> clientSocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>            recvData <span class="token operator">=</span> f<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>en_recvData<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"接受到客户端{0}传来的消息：{1}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>now_number<span class="token punctuation">,</span> recvData<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true"># 调用图灵机器人</span>            sendData <span class="token operator">=</span> get_reply<span class="token punctuation">(</span>recvData<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true"># 对消息进行加密</span>            en_sendData <span class="token operator">=</span> f<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>sendData<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            clientSocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>en_sendData<span class="token punctuation">)</span></code></pre><hr><h5 id="服务器端类实例化："><a href="#服务器端类实例化：" class="headerlink" title="服务器端类实例化："></a>服务器端类实例化：</h5><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> threading<span class="token keyword">from</span> serverclass <span class="token keyword">import</span> Server<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"欢迎使用服务端程序！"</span><span class="token punctuation">)</span>server <span class="token operator">=</span> Server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># 这里使用多线程可以避免服务器阻塞在一个客户端上</span>    t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>server<span class="token punctuation">.</span>link_one_client<span class="token punctuation">)</span>    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><hr><h4 id="客户端代码"><a href="#客户端代码" class="headerlink" title="客户端代码"></a>客户端代码</h4><hr><h5 id="客户端类定义："><a href="#客户端类定义：" class="headerlink" title="客户端类定义："></a>客户端类定义：</h5><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> socket<span class="token keyword">import</span> rsa<span class="token keyword">import</span> pickle<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>fernet <span class="token keyword">import</span> Fernet<span class="token keyword">import</span> hashlib<span class="token keyword">from</span> errorclass <span class="token keyword">import</span> AuthenticationError<span class="token keyword">class</span> <span class="token class-name">Client</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># 产生非对称密钥</span>        self<span class="token punctuation">.</span>asyKey <span class="token operator">=</span> rsa<span class="token punctuation">.</span>newkeys<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 公钥和私钥</span>        self<span class="token punctuation">.</span>publicKey <span class="token operator">=</span> self<span class="token punctuation">.</span>asyKey<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>privateKey <span class="token operator">=</span> self<span class="token punctuation">.</span>asyKey<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    <span class="token keyword">def</span> <span class="token function">link_server</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> addr<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># 创建socket通信对象</span>        <span class="token comment" spellcheck="true"># 默认使用AF_INET协议族，即ipv4地址和端口号的组合以及tcp协议</span>        clientSocket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 默认连接服务器地址为本机ip和8080端口</span>        clientSocket<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 向服务器传递公钥，和该公钥字符串化后的sha256值</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"正在向服务器传送公钥"</span><span class="token punctuation">)</span>        sendKey <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>self<span class="token punctuation">.</span>publicKey<span class="token punctuation">)</span>        sendKeySha256 <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>sendKey<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>        clientSocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">(</span>sendKey<span class="token punctuation">,</span> sendKeySha256<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 接受服务器传递的密钥并进行解密</span>        symKey<span class="token punctuation">,</span> symKeySha256 <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>clientSocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>symKey<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> symKeySha256<span class="token punctuation">:</span>            <span class="token keyword">raise</span> AuthenticationError<span class="token punctuation">(</span><span class="token string">"密钥被篡改！"</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>symKey <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>rsa<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>symKey<span class="token punctuation">,</span> self<span class="token punctuation">.</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"密钥交换完成"</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 初始化加密对象</span>        f <span class="token operator">=</span> Fernet<span class="token punctuation">(</span>self<span class="token punctuation">.</span>symKey<span class="token punctuation">)</span>        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>            sendData <span class="token operator">=</span> input<span class="token punctuation">(</span><span class="token string">"输入你要发送的消息："</span><span class="token punctuation">)</span>            en_sendData <span class="token operator">=</span> f<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>sendData<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            clientSocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>en_sendData<span class="token punctuation">)</span>            en_recvData <span class="token operator">=</span> clientSocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>            recvData <span class="token operator">=</span> f<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>en_recvData<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"接受到服务器传来的消息：{0}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>recvData<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><hr><h5 id="客户端类实例化："><a href="#客户端类实例化：" class="headerlink" title="客户端类实例化："></a>客户端类实例化：</h5><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> clientclass <span class="token keyword">import</span> Client<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"欢迎使用客户端程序！"</span><span class="token punctuation">)</span>client <span class="token operator">=</span> Client<span class="token punctuation">(</span><span class="token punctuation">)</span>client<span class="token punctuation">.</span>link_server<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><hr><h4 id="调用图灵机器人的代码"><a href="#调用图灵机器人的代码" class="headerlink" title="调用图灵机器人的代码"></a>调用<a href="https://www.kancloud.cn/turing/www-tuling123-com/718218" target="_blank" rel="noopener">图灵</a>机器人的代码</h4><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">import</span> json<span class="token keyword">def</span> <span class="token function">get_reply</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    datas <span class="token operator">=</span> <span class="token punctuation">{</span>        <span class="token string">'reqType'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token string">"perception"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token string">"inputText"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                <span class="token string">"text"</span><span class="token punctuation">:</span> data            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token string">"selfInfo"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                <span class="token string">"location"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                    <span class="token string">"city"</span><span class="token punctuation">:</span> <span class="token string">"武汉"</span><span class="token punctuation">,</span>                    <span class="token string">"province"</span><span class="token punctuation">:</span> <span class="token string">"湖北"</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">"userInfo"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true"># 这里填上自己的apiKey</span>            <span class="token string">"apiKey"</span><span class="token punctuation">:</span> <span class="token string">"*********************"</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true"># userid可以随便填写</span>            <span class="token string">"userId"</span><span class="token punctuation">:</span> <span class="token string">"443545"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    datas <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>datas<span class="token punctuation">)</span>    url <span class="token operator">=</span> <span class="token string">"http://openapi.tuling123.com/openapi/api/v2"</span>    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>datas<span class="token punctuation">)</span>    <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"results"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"values"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">)</span></code></pre><hr><h3 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h3><ul><li><a href="https://cryptography.io/en/latest/" target="_blank" rel="noopener">cryptography</a></li><li><a href="https://www.jb51.net/article/119048.htm" target="_blank" rel="noopener">rsa</a></li><li><a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017787560490144" target="_blank" rel="noopener">廖雪峰老师–网络编程</a></li><li><a href="https://segmentfault.com/a/1190000012968005" target="_blank" rel="noopener">python(3.x) 实现AES 加解密</a></li><li><a href="https://www.cnblogs.com/wangcq/p/3520400.html" target="_blank" rel="noopener">Socket通信原理</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> cryptography </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> socket </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
